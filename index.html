<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM üå∂Ô∏è</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #e62117; 
            --accent-soft: rgba(230, 33, 23, 0.1);
            --bg: #f2f4f7;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; background: var(--bg); height: 100vh; overflow: hidden; 
        }

        /* --- UI ELEMENTS --- */
        .glass-btn { 
            background: linear-gradient(135deg, #ff4b42 0%, #e62117 100%);
            color: #fff; border: none; border-radius: 18px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; box-shadow: 0 4px 12px rgba(230, 33, 23, 0.2);
        }
        .glass-btn:active { transform: scale(0.95); opacity: 0.9; }

        .input-premium {
            background: #fff; border: 1.5px solid #eee; padding: 14px 18px;
            border-radius: 18px; font-size: 16px; width: 100%; transition: 0.3s;
        }
        .input-premium:focus { border-color: var(--accent); outline: none; }

        /* --- AUTH --- */
        #auth-screen { 
            position: fixed; inset: 0; background: #fff; z-index: 999999; 
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        /* --- LAYOUT --- */
        #crm-ui { display: none; height: 100vh; flex-direction: column; }
        
        .nav-bar { 
            padding: calc(var(--safe-top) + 10px) 15px 10px;
            background: #fff; border-bottom: 1px solid #eee;
            display: flex; gap: 8px; z-index: 1000;
        }
        .nav-tab { 
            padding: 10px 18px; border-radius: 12px; font-size: 14px; font-weight: 700; 
            color: #666; cursor: pointer; background: #f8f9fa;
        }
        .nav-tab.active { background: var(--accent); color: #fff; }

        /* --- SIDEBAR (CHATS LIST) --- */
        .side-panel { 
            position: absolute; inset: 0; z-index: 500; background: #fff;
            display: flex; flex-direction: column; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .side-panel.hidden { transform: translateX(-100%); }

        .chat-row { 
            margin: 8px 12px; padding: 15px; background: #f8f9fa; border-radius: 20px;
            position: relative; border: 2px solid transparent; transition: 0.2s;
        }
        .chat-row.selected { border-color: var(--accent); background: #fff; }

        .assign-btn {
            position: absolute; right: 10px; top: 10px; width: 38px; height: 38px;
            border-radius: 12px; background: #fff; border: 1px solid #eee;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }

        /* --- CHAT VIEW --- */
        .chat-viewport { 
            flex: 1; display: flex; flex-direction: column; background: #e5ddd5;
            position: relative; z-index: 100;
        }
        .messages-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.in { align-self: flex-start; background: #fff; border-bottom-left-radius: 4px; }
        .msg.out { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 4px; }
        .msg.sys { align-self: center; background: rgba(0,0,0,0.05); font-size: 11px; font-weight: 700; color: #555; border-radius: 8px; padding: 4px 12px; }

        .chat-footer { 
            padding: 10px 10px calc(var(--safe-bottom) + 10px);
            background: #fff; display: flex; gap: 8px; align-items: center;
        }

        /* --- SETTINGS --- */
        .settings-view { 
            padding: 20px; overflow-y: auto; background: #fff; flex: 1;
        }
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }

        /* --- MODAL --- */
        #modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 9999; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-card { 
            width: 100%; background: #fff; border-radius: 25px 25px 0 0; 
            padding: 25px 20px calc(var(--safe-bottom) + 20px); 
            animation: slideUp 0.3s ease; 
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .mgr-opt { 
            padding: 16px; border-radius: 15px; background: #f8f9fa; 
            margin-bottom: 8px; text-align: center; font-weight: 700;
        }
    </style>
</head>
<body onclick="initAudio()">

    <div id="auth-screen">
        <div style="width: 100%; max-width: 320px; text-align: center;">
            <h1 style="font-weight: 800; color: var(--accent);">üå∂Ô∏è Latiao CRM</h1>
            <p style="color: #888; margin-bottom: 30px;">–í—Ö—ñ–¥ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—É</p>
            <input type="text" id="al" class="input-premium" placeholder="–õ–æ–≥—ñ–Ω" style="margin-bottom: 10px;">
            <input type="password" id="ap" class="input-premium" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom: 20px;">
            <button class="glass-btn" style="width: 100%; height: 55px;" onclick="login()">–£–í–Ü–ô–¢–ò</button>
        </div>
    </div>

    <div id="crm-ui">
        <nav class="nav-bar">
            <div class="nav-tab active" onclick="nav('support', this)">–ß–ê–¢–ò <span id="chat-count"></span></div>
            <div id="t-settings" class="nav-tab" onclick="nav('settings', this)">–ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø</div>
        </nav>

        <div style="flex: 1; display: flex; position: relative; overflow: hidden;">
            
            <aside class="side-panel" id="side-p">
                <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; gap: 8px;">
                    <button class="nav-tab" style="flex:1" onclick="setMode('active')">–ê–∫—Ç–∏–≤–Ω—ñ</button>
                    <button class="nav-tab" style="flex:1" onclick="setMode('archived')">–ê—Ä—Ö—ñ–≤</button>
                </div>
                <div id="chat-list" style="flex: 1; overflow-y: auto;"></div>
                <button onclick="logout()" style="padding: 20px; border: none; background: none; color: #999; font-weight: 700;">üö™ –í–∏–π—Ç–∏</button>
            </aside>

            <main class="chat-viewport view-tab active" id="view-support">
                <div class="messages-container" id="m-area"></div>
                
                <div id="scripts-bar" style="display: flex; gap: 6px; padding: 10px; overflow-x: auto; background: #fff; border-top: 1px solid #eee;"></div>
                
                <form class="chat-footer" onsubmit="send(event)">
                    <button type="button" class="glass-btn" style="width: 45px; height: 45px; background: #000;" onclick="toggleSide(true)">‚ò∞</button>
                    <input type="text" id="msg-in" class="input-premium" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
                    <button type="submit" class="glass-btn" style="width: 45px; height: 45px;">‚û§</button>
                </form>
            </main>

            <main class="view-tab settings-view" id="view-settings" style="display:none;">
                <h2 style="font-weight: 800;">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
                
                <div class="admin-only">
                    <section style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 20px;">
                        <h3>üß§ –ú–µ–Ω–µ–¥–∂–µ—Ä–∏</h3>
                        <div id="mgr-list"></div>
                        <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;">
                            <input type="text" id="nm" class="input-premium" placeholder="–Ü–º'—è">
                            <input type="text" id="nl" class="input-premium" placeholder="–õ–æ–≥—ñ–Ω">
                            <input type="text" id="np" class="input-premium" placeholder="–ü–∞—Ä–æ–ª—å">
                            <button class="glass-btn" style="height: 50px;" onclick="addM()">–î–æ–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø</button>
                        </div>
                    </section>

                    <section style="padding: 20px; background: #f8f9fa; border-radius: 20px;">
                        <h3>‚ö° –°–∫—Ä—ñ–ø—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</h3>
                        <div id="scripts-edit-list"></div>
                        <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;">
                            <input type="text" id="stitle" class="input-premium" placeholder="–ù–∞–∑–≤–∞ –∫–Ω–æ–ø–∫–∏">
                            <textarea id="stext" class="input-premium" placeholder="–¢–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ" style="height: 80px;"></textarea>
                            <button class="glass-btn" style="height: 50px; background: #333;" onclick="addScript()">–î–æ–¥–∞—Ç–∏ —Å–∫—Ä—ñ–ø—Ç</button>
                        </div>
                    </section>
                </div>

                <div style="margin-top: 20px; color: #888; font-size: 14px; text-align: center;">
                    –í–µ—Ä—Å—ñ—è CRM: 2.5 Winter Edition
                </div>
            </main>
        </div>
    </div>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h3 style="margin: 0 0 20px; text-align: center;">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ–≥–æ</h3>
            <div id="mgr-options"></div>
            <button class="glass-btn" style="width:100%; background:#eee; color:#000; box-shadow:none; margin-top:10px" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('user'));
    let curId = null, mode = 'active', managers = {};
    const sounds = { click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'), send: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3') };

    function initAudio() { Object.values(sounds).forEach(s => { s.play().then(()=>s.pause()); }); }
    function playS(t) { sounds[t].currentTime=0; sounds[t].play().catch(()=>{}); }

    function login() {
        const l=document.getElementById('al').value, p=document.getElementById('ap').value;
        if(l==='admin' && p==='latiao2024') return logOk({name:'–í–ª–∞—Å–Ω–∏–∫', role:'admin', id:'admin'});
        
        db.ref('managers').once('value', snap => {
            snap.forEach(m => {
                const d=m.val();
                if(d.login===l && d.pass===p) logOk({name:d.name, role:'manager', id:m.key});
            });
        });
    }
    function logOk(d) { localStorage.setItem('user', JSON.stringify(d)); location.reload(); }
    function logout() { localStorage.clear(); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('crm-ui').style.display='flex';
        if(user.role === 'admin') document.body.classList.add('is-admin');
        init();
    }

    function init() {
        db.ref('managers').on('value', snap => { 
            managers = snap.val() || {}; 
            if(user.role==='admin') renderMgrs(); 
            loadList(); 
        });
        db.ref('active_chats').on('value', snap => {
            document.getElementById('chat-count').innerText = snap.numChildren();
            loadList();
        });
        db.ref('config/scripts').on('value', snap => {
            const sc = snap.val() || {};
            const bar = document.getElementById('scripts-bar'); 
            const editList = document.getElementById('scripts-edit-list');
            bar.innerHTML = ''; editList.innerHTML = '';
            
            Object.keys(sc).forEach(key => {
                const s = sc[key];
                // Button for chat
                const b = document.createElement('button'); b.className='nav-tab'; b.innerText=s.title;
                b.style.whiteSpace='nowrap'; b.onclick=()=>{ document.getElementById('msg-in').value=s.text; playS('click'); };
                bar.appendChild(b);
                // List for admin settings
                if(user.role==='admin') {
                    editList.innerHTML += `<div class="mgr-opt" style="font-size:12px; display:flex; justify-content:space-between">
                        <span>${s.title}</span><span onclick="db.ref('config/scripts/${key}').remove()" style="color:red">–í–∏–¥–∞–ª–∏—Ç–∏</span>
                    </div>`;
                }
            });
        });
    }

    function loadList() {
        const path = mode==='active'?'active_chats':'closed_chats';
        db.ref(path).once('value', snap => {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                if(user.role==='manager' && d.assignedTo && d.assignedTo !== user.id) return;
                
                const div = document.createElement('div');
                div.className = `chat-row ${curId===c.key?'selected':''}`;
                const mName = d.assignedTo==='admin'?'–í–ª–∞—Å–Ω–∏–∫':(managers[d.assignedTo]?.name || '‚Äî');
                
                div.innerHTML = `
                    <div style="font-weight:800; font-size:14px">üë§ ${c.key.substring(0,10)}</div>
                    <div style="font-size:12px; color:#888; margin-top:4px">${d.lastMsg || '...'}</div>
                    <div style="font-size:10px; color:var(--accent); font-weight:800; margin-top:5px">üß§ ${mName}</div>
                    <button class="assign-btn" onclick="event.stopPropagation(); openAssign('${c.key}')">üë§</button>
                `;
                div.onclick = () => { curId=c.key; openChat(c.key); toggleSide(false); playS('click'); };
                list.appendChild(div);
            });
        });
    }

    function openAssign(cid) {
        document.getElementById('modal-overlay').style.display='flex';
        const opt = document.getElementById('mgr-options'); 
        opt.innerHTML = `<div class="mgr-opt" onclick="assign('${cid}','admin')">üëë –í–ª–∞—Å–Ω–∏–∫</div>`;
        Object.keys(managers).forEach(id => {
            opt.innerHTML += `<div class="mgr-opt" onclick="assign('${cid}','${id}')">üß§ ${managers[id].name}</div>`;
        });
    }

    function assign(cid, mid) {
        const name = mid==='admin'?'–í–ª–∞—Å–Ω–∏–∫':managers[mid].name;
        db.ref('active_chats/'+cid).update({assignedTo: mid});
        db.ref('support/'+cid).push({text: `üß§ –ü–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –Ω–∞: ${name}`, type:'sys', ts: Date.now()});
        closeModal(); playS('click');
    }

    function openChat(id) {
        db.ref('support/'+id).on('value', snap => {
            const area = document.getElementById('m-area'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                area.innerHTML += `<div class="msg ${d.type==='sys'?'sys':(d.type==='out'?'out':'in')}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function send(e) {
        e.preventDefault(); const i=document.getElementById('msg-in');
        if(!curId || !i.value) return;
        db.ref('support/'+curId).push({text: i.value, type:'out', ts: Date.now()});
        db.ref('active_chats/'+curId).update({lastMsg: "–í–∏: "+i.value});
        i.value=''; playS('send');
    }

    function toggleSide(s) { document.getElementById('side-p').classList.toggle('hidden', !s); }
    function nav(t, el) {
        document.querySelectorAll('.view-tab').forEach(v=>v.style.display='none');
        document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
        document.getElementById('view-'+t).style.display='flex'; el.classList.add('active');
        if(t==='support') toggleSide(true);
    }

    function closeModal() { document.getElementById('modal-overlay').style.display='none'; }
    function setMode(m) { mode=m; loadList(); }

    // Admin Functions
    function addM() {
        const n=document.getElementById('nm').value, l=document.getElementById('nl').value, p=document.getElementById('np').value;
        if(n && l && p) db.ref('managers').push({name:n, login:l, pass:p});
    }
    function renderMgrs() {
        const l = document.getElementById('mgr-list'); l.innerHTML = '';
        Object.keys(managers).forEach(id => {
            l.innerHTML += `<div class="mgr-opt" style="font-size:12px; display:flex; justify-content:space-between">
                <span>${managers[id].name}</span><span onclick="db.ref('managers/${id}').remove()" style="color:red">‚úï</span>
            </div>`;
        });
    }
    function addScript() {
        const t=document.getElementById('stitle').value, txt=document.getElementById('stext').value;
        if(t && txt) db.ref('config/scripts').push({title:t, text:txt});
        document.getElementById('stitle').value=''; document.getElementById('stext').value='';
    }
</script>
</body>
</html>
