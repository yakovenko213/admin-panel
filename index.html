<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM PRO | Smart Distribution ‚ùÑÔ∏è</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #e62117; --accent-glow: rgba(230, 33, 23, 0.12); --chrome-bg: #dfe1e5; --chrome-tab: #ffffff; --sidebar-bg: #f8f9fa; --border: #e8eaed; --gold: #ffd700; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--chrome-bg); display: flex; flex-direction: column; }

        .snowflake { position: fixed; top: -10%; z-index: 9999; color: #fff; font-size: 1em; user-select: none; pointer-events: none; animation: snow-fall 10s linear infinite; }
        @keyframes snow-fall { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

        #auth-screen { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1470&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: 999999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 360px; text-align: center; background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 2px solid var(--gold); position: relative; }
        .auth-card::before { content: 'üéÑ'; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 50px; }
        .auth-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 12px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; }

        #crm-ui { display: none; height: 100%; flex-direction: column; position: relative; }
        .christmas-decor { position: absolute; top: 0; left: 0; width: 100%; height: 50px; background: url('https://www.transparentpng.com/download/christmas-decoration/pine-branches-with-ornaments-christmas-decoration-png-19.png'); background-size: contain; background-repeat: repeat-x; z-index: 1001; pointer-events: none; opacity: 0.8; }
        .chrome-header { display: flex; align-items: flex-end; padding: 8px 8px 0; gap: 4px; background: var(--chrome-bg); border-bottom: 1px solid #c1c3c8; flex-shrink: 0; z-index: 1002; }
        .tab { position: relative; padding: 10px 15px; min-width: 140px; height: 38px; background: transparent; border-radius: 12px 12px 0 0; cursor: pointer; font-size: 13px; font-weight: 600; color: #5f6368; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab.active { background: var(--chrome-tab); color: var(--accent); }
        .app-shell { flex: 1; display: flex; background: #fff; overflow: hidden; position: relative; }
        .sidebar { width: 100%; height: 100%; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: absolute; z-index: 100; transition: transform 0.3s ease; }
        .sidebar.hidden { transform: translateX(-100%); }
        @media (min-width: 992px) { .sidebar { position: relative; width: 340px; transform: none !important; } }

        .chat-item { padding: 12px; border-radius: 15px; margin-bottom: 8px; cursor: pointer; background: #fff; border: 1px solid #eee; transition: 0.2s; position: relative; }
        .chat-item.assigned { border-left: 5px solid #007aff; }
        .assign-tag { font-size: 9px; background: #007aff; color: #fff; padding: 2px 6px; border-radius: 4px; position: absolute; top: 10px; right: 10px; }

        .viewport { flex: 1; display: flex; flex-direction: column; background: #fff; height: 100%; }
        .msg-area { flex: 1; padding: 15px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 10px 14px; border-radius: 18px; max-width: 85%; font-size: 14px; line-height: 1.4; }
        .bubble.in { align-self: flex-start; background: #fff; border: 1px solid #eee; }
        .bubble.out { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.system { align-self: center; background: #e2e8f0; color: #475569; font-size: 11px; font-weight: 700; border-radius: 10px; }

        .footer { padding: 10px 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #fff; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .footer input { flex: 1; height: 44px; padding: 0 18px; border-radius: 22px; border: 1px solid #eee; background: #f5f5f5; font-size: 16px; }
        
        .manager-select { padding: 5px; font-size: 10px; border-radius: 5px; margin-top: 5px; width: 100%; }
        .hidden-tab { display: none !important; }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color: var(--accent);">Latiao CRM</h2>
            <p style="color: #666; font-size: 13px; margin-bottom: 25px;">üéÑ –ó–∏–º–æ–≤–∏–π —Å–µ–∑–æ–Ω 2026 ‚ùÑÔ∏è</p>
            <input type="text" id="auth-login" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="tryLogin()">–£–í–Ü–ô–¢–ò</button>
        </div>
    </div>

    <div id="crm-ui">
        <div class="christmas-decor"></div>
        <header class="chrome-header">
            <div class="tab active" onclick="nav('support', this)"><span>üí¨ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞</span> <b id="b-total" style="font-size:10px; margin-left:5px;">0</b></div>
            <div id="tab-comm" class="tab" onclick="nav('community', this)"><span>üå∂Ô∏è –°–ø—ñ–ª—å–Ω–æ—Ç–∞</span></div>
            <div id="tab-set" class="tab" onclick="nav('settings', this)"><span>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></div>
        </header>

        <div class="app-shell">
            <aside class="sidebar" id="side-panel">
                <div style="padding:15px; background:#fff; border-bottom:1px solid #eee;">
                    <small id="greeting-txt" style="font-weight:800; color:#555;"></small>
                </div>
                <div id="chat-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
                <button onclick="logout()" style="padding:15px; border:none; color:red; font-size:12px; font-weight:bold; cursor:pointer;">üö™ –í–∏–π—Ç–∏</button>
            </aside>

            <main class="viewport view-tab active" id="view-support">
                <div style="padding:10px 15px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px;">
                    <button class="auth-btn" style="width:35px; height:35px; padding:0; background:#000;" onclick="document.getElementById('side-panel').classList.remove('hidden')">‚Äπ</button>
                    <b id="active-user" style="font-size:14px">–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç</b>
                    <button id="btn-archive" style="margin-left:auto; border:none; color:var(--accent); font-weight:800; cursor:pointer; background:none;" onclick="archiveChat()">–ó–ê–ö–†–ò–¢–ò</button>
                </div>
                <div class="msg-area" id="support-msgs"></div>
                <div class="footer">
                    <input type="text" id="s-input" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                    <button onclick="sendS()" style="background:#000; color:#fff; border:none; width:44px; height:44px; border-radius:50%; cursor:pointer;">‚û§</button>
                </div>
            </main>

            <main class="viewport view-tab" id="view-community" style="display:none; padding:20px;">
                <h4>–ß–∞—Ç —Å–ø—ñ–ª—å–Ω–æ—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –≤–ª–∞—Å–Ω–∏–∫—É.</h4>
            </main>

            <main class="viewport view-tab" id="view-settings" style="display:none; padding:20px; overflow-y:auto;">
                <div class="set-card">
                    <h4>üë• –ö–µ—Ä—É–≤–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏</h4>
                    <div id="managers-list"></div>
                    <hr>
                    <input type="text" id="new-mgr-name" class="auth-input" placeholder="–Ü–º'—è">
                    <input type="text" id="new-mgr-login" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
                    <input type="text" id="new-mgr-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="auth-btn" onclick="addManager()">–î–æ–¥–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
                </div>
            </main>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('crm_user'));
    let curId = null, managers = {};

    function createSnow() {
        const container = document.getElementById('snow-container');
        for (let i = 0; i < 20; i++) {
            let snow = document.createElement('div');
            snow.className = 'snowflake'; snow.innerHTML = '‚ùÑ';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.animationDuration = (Math.random() * 5 + 5) + 's';
            snow.style.opacity = Math.random();
            container.appendChild(snow);
        }
    }
    createSnow();

    function tryLogin() {
        const l = document.getElementById('auth-login').value;
        const p = document.getElementById('auth-pass').value;
        if(l === 'admin' && p === 'latiao2024') return loginOk({name: '–í–ª–∞—Å–Ω–∏–∫', role: 'owner', id: 'admin'});
        
        db.ref('managers').once('value', snap => {
            let found = false;
            snap.forEach(m => {
                const d = m.val();
                if(d.login === l && d.pass === p) { loginOk({name: d.name, role: 'manager', id: m.key}); found = true; }
            });
            if(!found) alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É');
        });
    }

    function loginOk(d) {
        localStorage.setItem('crm_user', JSON.stringify(d));
        user = d;
        location.reload();
    }

    function logout() { localStorage.removeItem('crm_user'); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('crm-ui').style.display = 'flex';
        const hr = new Date().getHours();
        const gr = hr < 12 ? "–î–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫" : hr < 18 ? "–î–æ–±—Ä–∏–π –¥–µ–Ω—å" : "–î–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä";
        document.getElementById('greeting-txt').innerText = `${gr}, ${user.name}! üéÑ`;
        
        if(user.role === 'manager') {
            document.getElementById('tab-comm').classList.add('hidden-tab');
            document.getElementById('tab-set').classList.add('hidden-tab');
        }
        init();
    }

    function init() {
        db.ref('managers').on('value', snap => {
            managers = snap.val() || {};
            if(user.role === 'owner') renderManagers();
            loadList();
        });

        db.ref('active_chats').on('value', snap => {
            document.getElementById('b-total').innerText = snap.numChildren();
            loadList();
        });
    }

    function loadList() {
        db.ref('active_chats').once('value', snap => {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                // –Ø–∫—â–æ –º–µ–Ω–µ–¥–∂–µ—Ä - –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –π–æ–≥–æ —á–∞—Ç–∏ –∞–±–æ –Ω—ñ—á–∏—ó
                if(user.role === 'manager' && d.assignedTo && d.assignedTo !== user.id) return;

                const div = document.createElement('div');
                div.className = `chat-item ${d.assignedTo ? 'assigned' : ''}`;
                const mName = d.assignedTo === 'admin' ? '–í–ª–∞—Å–Ω–∏–∫' : (managers[d.assignedTo]?.name || '');
                
                div.innerHTML = `
                    <strong>üë§ ${c.key.substring(0,8)}</strong>
                    ${d.assignedTo ? `<span class="assign-tag">${mName}</span>` : ''}
                    <br><small>${d.lastMsg || '...'}</small>
                `;

                // –¢—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ –ø—Ä–∏–∑–Ω–∞—á–∞—Ç–∏
                if(user.role === 'owner') {
                    const sel = document.createElement('select');
                    sel.className = 'manager-select';
                    sel.innerHTML = `<option value="">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏...</option><option value="admin">–í–ª–∞—Å–Ω–∏–∫</option>`;
                    Object.keys(managers).forEach(id => {
                        sel.innerHTML += `<option value="${id}" ${d.assignedTo === id ? 'selected' : ''}>${managers[id].name}</option>`;
                    });
                    sel.onclick = (e) => e.stopPropagation();
                    sel.onchange = (e) => assignChat(c.key, e.target.value);
                    div.appendChild(sel);
                }

                div.onclick = () => { curId = c.key; openChat(c.key); };
                list.appendChild(div);
            });
        });
    }

    function assignChat(chatId, managerId) {
        if(!managerId) return;
        const mName = managerId === 'admin' ? '–í–ª–∞—Å–Ω–∏–∫' : managers[managerId].name;
        db.ref('active_chats/' + chatId).update({ assignedTo: managerId });
        db.ref('support/' + chatId).push({
            text: `üìù –ú–µ–Ω–µ–¥–∂–µ—Ä–∞ ${mName} –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –Ω–∞ —Ü–µ–π –¥—ñ–∞–ª–æ–≥`,
            type: 'system',
            ts: Date.now()
        });
    }

    function openChat(id) {
        document.getElementById('active-user').innerText = "–ß–∞—Ç: " + id.substring(0,8);
        db.ref('support/' + id).on('value', snap => {
            const area = document.getElementById('support-msgs'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                const div = document.createElement('div');
                div.className = `bubble ${d.type}`;
                div.innerText = d.text;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendS() {
        const i = document.getElementById('s-input');
        if(!curId || !i.value) return;
        db.ref('support/' + curId).push({ text: i.value, type: 'out', ts: Date.now() });
        db.ref('active_chats/' + curId).update({ lastMsg: "–ú–µ–Ω–µ–¥–∂–µ—Ä: " + i.value });
        i.value = '';
    }

    function archiveChat() {
        if(!curId) return;
        if(confirm('–ó–∞–∫—Ä–∏—Ç–∏ —á–∞—Ç?')) {
            db.ref('active_chats/' + curId).remove();
            db.ref('support/' + curId).remove();
            curId = null; document.getElementById('support-msgs').innerHTML = '';
        }
    }

    function nav(tab, el) {
        document.querySelectorAll('.view-tab').forEach(v => v.style.display = 'none');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('view-' + tab).style.display = 'flex';
        el.classList.add('active');
    }

    function renderManagers() {
        const list = document.getElementById('managers-list'); list.innerHTML = '';
        Object.keys(managers).forEach(id => {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>${managers[id].name}</span>
                <button onclick="db.ref('managers/${id}').remove()" style="color:red">‚úï</button>
            </div>`;
        });
    }

    function addManager() {
        const n = document.getElementById('new-mgr-name').value;
        const l = document.getElementById('new-mgr-login').value;
        const p = document.getElementById('new-mgr-pass').value;
        if(n && l && p) db.ref('managers').push({ name: n, login: l, pass: p });
    }
</script>
</body>
</html>
