<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao Admin Club | Premium CRM ‚ùÑÔ∏è</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #e62117;
            --primary-gradient: linear-gradient(135deg, #ff4b42 0%, #e62117 100%);
            --chrome-bg: #dee1e6;
            --chrome-tab: #ffffff;
            --bg: #f8f9fb;
            --border: #e2e8f0;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --safe-top: env(safe-area-inset-top);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); 
            height: 100vh; overflow: hidden; color: #1a1a1a;
        }

        /* --- –ù–û–í–û–†–Ü–ß–ù–ò–ô –î–ï–ö–û–† --- */
        body::after {
            content: ""; position: fixed; inset: 0; pointer-events: none;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
            opacity: 0.1; z-index: 9999;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; inset: 0; background: url('https://images.unsplash.com/photo-1543508282-5c1f427f003f?q=80&w=1470&auto=format&fit=crop');
            background-size: cover; z-index: 10000; display: flex; align-items: center; justify-content: center;
        }
        #auth-screen::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); }
        .auth-card {
            position: relative; background: rgba(255,255,255,0.9); padding: 40px; border-radius: 30px;
            width: 90%; max-width: 380px; text-align: center; box-shadow: var(--shadow);
        }
        .auth-card h2 { color: var(--primary); font-weight: 800; margin-top: 0; }

        /* --- UI COMPONENTS --- */
        .btn {
            padding: 12px 24px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer;
            transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 15px rgba(230,33,23,0.3); }
        .btn:active { transform: scale(0.96); filter: brightness(1.1); }

        .input-premium {
            width: 100%; padding: 14px 18px; border: 1.5px solid var(--border); border-radius: 14px;
            font-size: 16px; transition: 0.3s; background: white;
        }
        .input-premium:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(230,33,23,0.1); }

        /* --- LAYOUT --- */
        #crm-ui { display: none; height: 100vh; flex-direction: column; }
        
        header {
            background: var(--chrome-bg); padding: calc(var(--safe-top) + 8px) 12px 0;
            display: flex; align-items: flex-end; gap: 4px; border-bottom: 1px solid #c1c4c8;
        }
        .chrome-tab {
            background: #bdc1c6; padding: 10px 24px; border-radius: 12px 12px 0 0;
            font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s;
            color: #5f6368; position: relative;
        }
        .chrome-tab.active { background: white; color: var(--primary); }
        .chrome-tab::before { content: "‚ùÑÔ∏è"; margin-right: 6px; font-size: 12px; }

        .main-app { flex: 1; display: flex; overflow: hidden; background: white; }

        /* --- SIDEBAR --- */
        #side-bar {
            width: 350px; border-right: 1px solid var(--border); display: flex; flex-direction: column;
            background: #fff; transition: 0.3s ease;
        }
        .chat-row {
            padding: 18px; border-bottom: 1px solid #f1f3f5; cursor: pointer;
            transition: 0.2s; position: relative;
        }
        .chat-row:hover { background: #f8f9fa; }
        .chat-row.selected { background: #fff1f0; border-left: 4px solid var(--primary); }
        .chat-row .unread-dot {
            position: absolute; right: 18px; top: 18px; width: 10px; height: 10px;
            background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px rgba(230,33,23,0.5);
        }

        /* --- CHAT VIEW --- */
        #chat-view { flex: 1; display: flex; flex-direction: column; background: #f0f2f5 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .msg-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .bubble { 
            max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 14px; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
        }
        .bubble.user { align-self: flex-start; background: white; border-bottom-left-radius: 4px; }
        .bubble.admin { align-self: flex-end; background: var(--primary-gradient); color: white; border-bottom-right-radius: 4px; }
        .bubble small { display: block; font-size: 10px; margin-top: 5px; opacity: 0.7; text-align: right; }

        .footer { padding: 15px 25px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; gap: 10px; }

        /* --- MOBILE --- */
        @media (max-width: 850px) {
            #side-bar { position: fixed; inset: 0; z-index: 500; width: 100%; }
            #side-bar.hidden { transform: translateX(-100%); }
            .mobile-header { display: flex !important; }
        }

        .settings-card {
            background: #fff; padding: 25px; border-radius: 20px; border: 1px solid var(--border);
            margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
    </style>
</head>
<body onclick="initAudio()">

    <div id="auth-screen">
        <div class="auth-card">
            <h2>Latiao CRM üå∂Ô∏è</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 25px;">Winter Security Access</p>
            <input type="text" id="log-u" class="input-premium" placeholder="–õ–æ–≥—ñ–Ω" style="margin-bottom: 12px;">
            <input type="password" id="log-p" class="input-premium" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom: 20px;">
            <button class="btn btn-primary" style="width: 100%;" onclick="auth()">–£–í–Ü–ô–¢–ò</button>
        </div>
    </div>

    <div id="crm-ui">
        <header>
            <div style="font-weight: 800; color: var(--primary); padding: 0 20px 12px; font-size: 18px;">Latiao Admin</div>
            <div id="t-chats" class="chrome-tab active" onclick="nav('chats')">–ß–∞—Ç–∏</div>
            <div id="t-sets" class="chrome-tab" onclick="nav('settings')">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 15px; padding-bottom: 10px; padding-right: 20px;">
                <span id="welcome-msg" style="font-size: 12px; font-weight: 600;"></span>
                <button onclick="logout()" style="border:none; background:none; color: #999; cursor:pointer; font-weight:700">–í–∏—Ö—ñ–¥</button>
            </div>
        </header>

        <main class="main-app">
            <section id="view-chats" style="display: flex; width: 100%;">
                <aside id="side-bar">
                    <div style="padding: 20px; background: #fdfdfd; border-bottom: 1px solid #eee;">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn" style="flex:1; font-size:11px; background:#f0f0f0" onclick="setF('active')">–ê–∫—Ç–∏–≤–Ω—ñ</button>
                            <button class="btn" style="flex:1; font-size:11px; background:#f0f0f0" onclick="setF('closed')">–ê—Ä—Ö—ñ–≤</button>
                        </div>
                    </div>
                    <div id="chat-list-items" style="flex:1; overflow-y:auto"></div>
                </aside>

                <div id="chat-view">
                    <div class="mobile-header" style="display:none; padding:15px; background:white; align-items:center; gap:10px; border-bottom:1px solid #eee">
                        <button class="btn" onclick="toggleSide(true)">‚Üê –°–ø–∏—Å–∫–∏</button>
                        <b id="mob-title">–ß–∞—Ç</b>
                    </div>
                    
                    <div style="background: white; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee;">
                        <select id="mgr-select" onchange="assignTo(this.value)" class="input-premium" style="width:auto; padding:8px; font-size:12px"></select>
                        <button class="btn" style="background:#f1f5f9; font-size:11px" onclick="askPhone()">–ó–∞–ø–∏—Ç –Ω–æ–º–µ—Ä–∞</button>
                        <button class="btn" style="background:#fee2e2; color:#b91c1c; font-size:11px" onclick="closeChat()">–ó–∞–∫—Ä–∏—Ç–∏</button>
                    </div>

                    <div class="msg-container" id="msg-area"></div>

                    <div class="footer">
                        <button class="btn" style="background:#f1f5f9; width:50px; height:50px; padding:0" onclick="showScripts()">‚ö°</button>
                        <input type="text" id="adm-input" class="input-premium" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                        <button class="btn btn-primary" style="width:50px; height:50px; padding:0" onclick="sendMsg()">‚û§</button>
                    </div>
                </div>
            </section>

            <section id="view-settings" style="display:none; width: 100%; padding: 40px; overflow-y: auto;">
                <div style="max-width: 900px; margin: 0 auto;">
                    <div class="settings-card">
                        <h3>üéÑ –ß–∞—Ç –Ω–∞ —Å–∞–π—Ç—ñ</h3>
                        <label class="btn" style="background:#eee">
                            <input type="checkbox" id="chat-toggle" onchange="toggleSiteChat(this.checked)"> –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –≤—ñ–¥–∂–µ—Ç
                        </label>
                    </div>

                    <div class="settings-card">
                        <h3>üß§ –ú–µ–Ω–µ–¥–∂–µ—Ä–∏</h3>
                        <div id="mgr-crud-list" style="margin-bottom:20px"></div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px">
                            <input type="text" id="nm-n" class="input-premium" placeholder="–Ü–º'—è">
                            <input type="text" id="nm-l" class="input-premium" placeholder="–õ–æ–≥—ñ–Ω">
                            <input type="text" id="nm-p" class="input-premium" placeholder="–ü–∞—Ä–æ–ª—å">
                        </div>
                        <button class="btn btn-primary" style="margin-top:10px" onclick="addMgr()">–î–æ–¥–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-scripts" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:24px; width:90%; max-width:400px;">
            <h3>–®–≤–∏–¥–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</h3>
            <div id="scripts-list" style="display:grid; gap:10px;"></div>
            <button class="btn" style="width:100%; margin-top:20px; background:#f0f0f0" onclick="closeScripts()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('latiao_session'));
    let curId = null, filter = 'active', managers = {};
    const audio = { send: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3') };

    function initAudio() { Object.values(audio).forEach(a => { a.play().then(()=>a.pause()); }); }

    // AUTH
    function auth() {
        const l = document.getElementById('log-u').value;
        const p = document.getElementById('log-p').value;
        
        db.ref('managers').once('value', snap => {
            let found = false;
            snap.forEach(m => {
                const d = m.val();
                if(d.login === l && d.password === p) {
                    user = { ...d, id: m.key };
                    localStorage.setItem('latiao_session', JSON.stringify(user));
                    location.reload();
                    found = true;
                }
            });
            if(!found) alert("–ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ!");
        });
    }

    function logout() { localStorage.clear(); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('crm-ui').style.display = 'flex';
        startCRM();
    }

    function startCRM() {
        const hours = new Date().getHours();
        let g = hours < 5 ? "–î–æ–±—Ä–æ—ó –Ω–æ—á—ñ" : hours < 12 ? "–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É" : hours < 18 ? "–î–æ–±—Ä–æ–≥–æ –¥–Ω—è" : "–î–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞";
        document.getElementById('welcome-msg').innerText = `${g}, ${user.name}`;
        if(user.role !== 'admin') document.getElementById('t-sets').style.display = 'none';

        db.ref('managers').on('value', snap => {
            managers = snap.val() || {};
            renderMgrList();
            renderSettingsMgrs();
        });

        db.ref('active_chats').on('value', () => renderChats());
        db.ref('chats_meta').on('value', () => renderChats());
        
        db.ref('config/chat_enabled').once('value', s => document.getElementById('chat-toggle').checked = s.val());
    }

    function renderChats() {
        db.ref('active_chats').once('value', aSnap => {
            db.ref('chats_meta').once('value', mSnap => {
                const list = document.getElementById('chat-list-items');
                list.innerHTML = '';
                const metas = mSnap.val() || {};
                const active = aSnap.val() || {};

                Object.entries(active).sort((a,b) => b[1].ts - a[1].ts).forEach(([uid, data]) => {
                    const meta = metas[uid] || {};
                    if(filter === 'active' && meta.status === 'closed') return;
                    if(filter === 'closed' && meta.status !== 'closed') return;

                    const div = document.createElement('div');
                    div.className = `chat-row ${curId === uid ? 'selected' : ''}`;
                    div.innerHTML = `
                        <div style="font-weight:700; font-size:14px">üë§ ${uid.substring(0,8)}</div>
                        <div style="font-size:12px; color:#777; margin-top:4px">${data.lastMsg}</div>
                        <div style="font-size:10px; color:var(--primary); font-weight:700; margin-top:6px">üß§ ${meta.assignedManagerName || '–û—á—ñ–∫—É—î'}</div>
                    `;
                    
                    // Unread check
                    db.ref(`support/${uid}`).limitToLast(1).once('value', s => {
                        s.forEach(m => { if(m.val().type === 'user' && !m.val().seenByAdmin) div.innerHTML += '<div class="unread-dot"></div>'; });
                    });

                    div.onclick = () => selectChat(uid);
                    list.appendChild(div);
                });
            });
        });
    }

    function selectChat(uid) {
        curId = uid;
        if(window.innerWidth < 850) toggleSide(false);
        document.getElementById('mob-title').innerText = uid.substring(0,8);
        
        db.ref(`support/${uid}`).on('value', snap => {
            if(curId !== uid) return;
            const area = document.getElementById('msg-area');
            area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                if(d.type === 'user') d.ref?.update({seenByAdmin: true});
                const time = new Date(d.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                area.innerHTML += `
                    <div class="bubble ${d.type === 'admin' ? 'admin' : 'user'}">
                        ${d.text}
                        <small>${time} ${d.type==='admin' ? (d.read ? '‚úì‚úì' : '‚úì') : ''}</small>
                    </div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
        renderChats();
    }

    function sendMsg() {
        const inp = document.getElementById('adm-input');
        if(!curId || !inp.value.trim()) return;
        const val = inp.value;
        const ts = Date.now();

        db.ref(`support/${curId}`).push({ text: val, type: 'admin', ts, read: false });
        db.ref(`active_chats/${curId}`).update({ lastMsg: "–í–∏: " + val, ts });
        
        inp.value = '';
        audio.send.play();
    }

    function assignTo(mid) {
        if(!curId || !mid) return;
        const m = managers[mid];
        db.ref(`chats_meta/${curId}`).update({
            assignedManagerId: mid,
            assignedManagerName: m.name,
            updatedAt: Date.now()
        });
        
        // TG Notification
        if(m.telegramChatId) {
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: m.telegramChatId, text: `‚ùÑÔ∏è –ù–æ–≤–∏–π —á–∞—Ç –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ!\n–ö–ª—ñ—î–Ω—Ç: ${curId}` })
            });
        }
    }

    function closeChat() {
        if(!curId || !confirm("–ó–∞–∫—Ä–∏—Ç–∏ –¥—ñ–∞–ª–æ–≥?")) return;
        db.ref(`chats_meta/${curId}`).update({ status: 'closed' });
        db.ref(`active_chats/${curId}`).remove();
        curId = null;
        renderChats();
    }

    function toggleSide(v) { document.getElementById('side-bar').classList.toggle('hidden', !v); }
    function nav(v) {
        document.querySelectorAll('.chrome-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('t-' + (v==='chats'?'chats':'sets')).classList.add('active');
        document.getElementById('view-chats').style.display = v==='chats'?'flex':'none';
        document.getElementById('view-settings').style.display = v==='settings'?'block':'none';
    }

    function renderMgrList() {
        const sel = document.getElementById('mgr-select');
        sel.innerHTML = '<option value="">–ú–µ–Ω–µ–¥–∂–µ—Ä...</option>';
        Object.entries(managers).forEach(([id, m]) => {
            sel.innerHTML += `<option value="${id}">${m.name}</option>`;
        });
    }

    // SETTINGS LOGIC
    function addMgr() {
        const n = document.getElementById('nm-n').value;
        const l = document.getElementById('nm-l').value;
        const p = document.getElementById('nm-p').value;
        if(n && l && p) {
            db.ref('managers').push({ name:n, login:l, password:p, role:'manager', isActive:true });
            alert("–ú–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ–¥–∞–Ω–æ!");
        }
    }

    function toggleSiteChat(v) { db.ref('config/chat_enabled').set(v); }
    function setF(v) { filter = v; renderChats(); }
</script>
</body>
</html>
