<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao CRM: Automation & Stats</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e62117; --bg: #f4f4f9; --sidebar: #ffffff; --text: #1c1e21; --green: #34c759; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; text-align: center; color: var(--primary); }
        .nav-menu { display: flex; flex-direction: column; padding: 10px; gap: 5px; }
        .nav-item { padding: 12px 15px; border-radius: 10px; cursor: pointer; border: none; background: none; text-align: left; font-weight: 600; color: #555; }
        .nav-item.active { background: #fff1f0; color: var(--primary); }
        .chat-list { flex: 1; overflow-y: auto; border-top: 1px solid #eee; }
        .chat-box { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 13px; }
        .chat-box.active { background: #fef2f2; border-left: 4px solid var(--primary); }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 30px; }
        .tab-content.active { display: flex; flex-direction: column; }

        /* Chat Area */
        .msg-area { flex: 1; background: #f9f9fb; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; border-radius: 15px; }
        .scm { padding: 10px 15px; border-radius: 15px; max-width: 70%; font-size: 14px; }
        .scm.user { align-self: flex-start; background: #fff; border: 1px solid #eee; }
        .scm.admin { align-self: flex-end; background: var(--primary); color: #fff; }
        .input-form { display: flex; gap: 10px; padding-top: 20px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .btn { background: var(--primary); color: #fff; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* Settings & Stats */
        .settings-card { background: #f9f9f9; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        .settings-card label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; }
        .settings-card input, .settings-card textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #eee; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .stat-card h3 { margin: 0; font-size: 28px; color: var(--primary); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header"><h2>Latiao Admin</h2></div>
        <nav class="nav-menu">
            <button class="nav-item active" onclick="switchTab('chats')">üí¨ –î—ñ–∞–ª–æ–≥–∏</button>
            <button class="nav-item" onclick="switchTab('stats')">üìä –û—Ü—ñ–Ω–∫–∏ —Ç–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="nav-item" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞</button>
        </nav>
        <div id="chat-list" class="chat-list"></div>
    </aside>

    <main class="main">
        <section id="tab-chats" class="tab-content active">
            <div id="msg-area" class="msg-area"></div>
            <form class="input-form" onsubmit="sendMsg(event)">
                <input type="text" id="admin-input" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                <button type="submit" class="btn">‚û§</button>
            </form>
        </section>

        <section id="tab-stats" class="tab-content">
            <h2>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –∑–∞–¥–æ–≤–æ–ª–µ–Ω–æ—Å—Ç—ñ</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <h3 id="avg-rating">0.0</h3>
                    <p>–°–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-reviews">0</h3>
                    <p>–í—Å—å–æ–≥–æ –≤—ñ–¥–≥—É–∫—ñ–≤</p>
                </div>
            </div>
            <div id="reviews-list" style="margin-top: 30px;"></div>
        </section>

        <section id="tab-settings" class="tab-content">
            <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó</h2>
            <div class="settings-card">
                <label>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è-–Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è (—á–µ—Ä–µ–∑ X —Ö–≤):</label>
                <textarea id="set-msg-remind" rows="2"></textarea>
                <label>–ß–∞—Å –¥–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è (—Ö–≤):</label>
                <input type="number" id="set-time-remind">
                
                <hr>
                
                <label>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–∫—Ä–∏—Ç—Ç—è —Ç–∞ –æ—Ü—ñ–Ω–∫—É:</label>
                <textarea id="set-msg-close" rows="2"></textarea>
                <label>–ß–∞—Å –¥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø—ñ—Å–ª—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è (—Ö–≤):</label>
                <input type="number" id="set-time-close">
                
                <button class="btn" onclick="saveSettings()" style="background: var(--green);">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            </div>
        </section>
    </main>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentChatId = null;
    let botConfig = { msgRemind: "", timeRemind: 5, msgClose: "", timeClose: 5 };

    // --- –ù–ê–í–Ü–ì–ê–¶–Ü–Ø ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        if(tabId === 'stats') loadStats();
        if(tabId === 'settings') loadSettings();
    }

    // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
    function loadSettings() {
        db.ref('bot_config').once('value', s => {
            if(s.exists()) {
                botConfig = s.val();
                document.getElementById('set-msg-remind').value = botConfig.msgRemind;
                document.getElementById('set-time-remind').value = botConfig.timeRemind;
                document.getElementById('set-msg-close').value = botConfig.msgClose;
                document.getElementById('set-time-close').value = botConfig.timeClose;
            }
        });
    }

    function saveSettings() {
        const newData = {
            msgRemind: document.getElementById('set-msg-remind').value,
            timeRemind: parseInt(document.getElementById('set-time-remind').value),
            msgClose: document.getElementById('set-msg-close').value,
            timeClose: parseInt(document.getElementById('set-time-close').value)
        };
        db.ref('bot_config').set(newData).then(() => alert("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!"));
    }

    // --- –õ–û–ì–Ü–ö–ê –ß–ê–¢–Ü–í ---
    db.ref('active_chats').on('value', snap => {
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        snap.forEach(child => {
            const id = child.key;
            const chat = child.val();
            const div = document.createElement('div');
            div.className = `chat-box ${currentChatId === id ? 'active' : ''}`;
            div.innerHTML = `<strong>${id}</strong><br><small>${chat.lastMsg || ''}</small>`;
            div.onclick = () => selectChat(id);
            list.appendChild(div);
        });
    });

    function selectChat(id) {
        currentChatId = id;
        db.ref('support/' + id).on('value', snap => {
            const area = document.getElementById('msg-area');
            area.innerHTML = '';
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div');
                div.className = 'scm ' + (m.type === 'admin' ? 'admin' : 'user');
                div.innerText = m.text;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendMsg(e) {
        e.preventDefault();
        const input = document.getElementById('admin-input');
        if(!currentChatId || !input.value.trim()) return;
        
        const text = input.value;
        db.ref('support/' + currentChatId).push({ text: text, type: 'admin', ts: Date.now() });
        db.ref('active_chats/' + currentChatId).update({ 
            lastMsg: "–í–∏: " + text, 
            ts: Date.now(),
            status: 'active' 
        });
        input.value = '';
    }

    // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---
    function loadStats() {
        db.ref('ratings').on('value', snap => {
            let total = 0, sum = 0, html = '';
            snap.forEach(c => {
                const r = c.val();
                sum += parseInt(r.stars);
                total++;
                html += `<div class="stat-card" style="margin-bottom:10px; text-align:left;">
                    <b>–ö–ª—ñ—î–Ω—Ç ${c.key}:</b> –û—Ü—ñ–Ω–∫–∞ ${r.stars}‚≠ê <br><small>${new Date(r.ts).toLocaleString()}</small>
                </div>`;
            });
            document.getElementById('avg-rating').innerText = total > 0 ? (sum / total).toFixed(1) : "0.0";
            document.getElementById('total-reviews').innerText = total;
            document.getElementById('reviews-list').innerHTML = html;
        });
    }

    // --- –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–Ü–Ø (–§–û–ù–û–í–ò–ô –ü–†–û–¶–ï–°) ---
    setInterval(() => {
        const now = Date.now();
        db.ref('active_chats').once('value', snap => {
            snap.forEach(child => {
                const chat = child.val();
                const chatId = child.key;
                const diffMin = (now - chat.ts) / 60000;

                // 1. –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è
                if (chat.status === 'active' && diffMin >= botConfig.timeRemind) {
                    db.ref('support/' + chatId).push({ text: botConfig.msgRemind, type: 'admin', ts: now });
                    db.ref('active_chats/' + chatId).update({ ts: now, status: 'reminded' });
                }
                
                // 2. –ó–∞–∫—Ä–∏—Ç—Ç—è
                if (chat.status === 'reminded' && diffMin >= botConfig.timeClose) {
                    db.ref('support/' + chatId).push({ text: botConfig.msgClose, type: 'admin', ts: now });
                    // –î–æ–¥–∞—î–º–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ –≤ —á–∞—Ç –∫–ª—ñ—î–Ω—Ç–∞
                    db.ref('support/' + chatId).push({ text: "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ –≤—ñ–¥ 1 –¥–æ 5, —â–æ–± –æ—Ü—ñ–Ω–∏—Ç–∏ –Ω–∞—à—É —Ä–æ–±–æ—Ç—É.", type: 'system', ts: now });
                    db.ref('active_chats/' + chatId).remove(); // –í–∏–¥–∞–ª—è—î–º–æ –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö
                }
            });
        });
    }, 30000); // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫

</script>
</body>
</html>
