<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM PRO</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #e62117;
            --bg: #f4f7f9;
            --sidebar-width: 350px;
            --text-main: #1a1c1e;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main);
            overflow: hidden;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 9999; background: #fff;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box { width: 100%; max-width: 400px; padding: 40px; border-radius: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); text-align: center; }

        /* --- MAIN LAYOUT --- */
        #crm-ui { display: none; height: 100vh; flex-direction: column; }
        
        .header {
            height: 64px; background: #fff; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0;
        }

        .main-container { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background: #fff; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease;
        }

        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-card {
            padding: 16px; border-radius: 12px; margin-bottom: 10px; cursor: pointer;
            border: 1px solid transparent; background: #f8fafc; position: relative; transition: 0.2s;
        }
        .chat-card:hover { background: #f1f5f9; }
        .chat-card.active { border-color: var(--primary); background: #fef2f2; }

        /* --- CONTENT AREA --- */
        .content { flex: 1; display: flex; flex-direction: column; background: #fff; min-width: 0; }

        /* --- CHAT AREA --- */
        #view-support { display: flex; flex-direction: column; height: 100%; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; background: #f1f5f9; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { padding: 12px 16px; border-radius: 12px; max-width: 80%; font-size: 14px; line-height: 1.5; }
        .msg.in { align-self: flex-start; background: #fff; color: var(--text-main); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg.out { align-self: flex-end; background: var(--primary); color: #fff; }
        .msg.sys { align-self: center; background: #e2e8f0; font-size: 11px; font-weight: 600; color: #475569; }

        .chat-input-area { padding: 15px; border-top: 1px solid var(--border); background: #fff; }
        .scripts-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .scripts-row::-webkit-scrollbar { display: none; }
        .script-badge { padding: 6px 12px; background: #f1f5f9; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer; white-space: nowrap; border: 1px solid var(--border); }

        .input-group { display: flex; gap: 10px; }
        input, textarea { 
            width: 100%; padding: 12px 16px; border: 1px solid var(--border); 
            border-radius: 10px; font-family: inherit; font-size: 14px;
        }
        input:focus { border-color: var(--primary); outline: none; }

        .btn { 
            padding: 10px 20px; border-radius: 10px; border: none; font-weight: 600; 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-icon { width: 42px; height: 42px; padding: 0; flex-shrink: 0; }

        /* --- SETTINGS --- */
        .settings-container { padding: 30px; overflow-y: auto; flex: 1; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .settings-card { background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 24px; }

        /* --- MODAL --- */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal { background: #fff; width: 90%; max-width: 400px; border-radius: 20px; padding: 24px; }

        /* --- MOBILE --- */
        @media (max-width: 850px) {
            .sidebar { position: absolute; z-index: 50; height: 100%; transform: translateX(0); }
            .sidebar.hidden { transform: translateX(-100%); }
            .content { width: 100%; }
            .header-nav { display: none; }
        }

        .badge-mgr { font-size: 10px; font-weight: 700; color: var(--primary); background: #fef2f2; padding: 2px 6px; border-radius: 4px; margin-top: 5px; display: inline-block; }
    </style>
</head>
<body onclick="initAudio()">

    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="margin:0 0 10px; font-weight: 800;">üå∂Ô∏è Latiao CRM</h2>
            <p style="color:var(--text-secondary); margin-bottom: 30px;">–°–∏—Å—Ç–µ–º–∞ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏</p>
            <input type="text" id="al" placeholder="–õ–æ–≥—ñ–Ω" style="margin-bottom:12px">
            <input type="password" id="ap" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom:20px">
            <button class="btn btn-primary" style="width:100%; height:50px" onclick="login()">–£–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>
    </div>

    <div id="crm-ui">
        <header class="header">
            <div style="display:flex; align-items:center; gap:15px">
                <button class="btn btn-icon" onclick="toggleSidebar()" style="background:#f1f5f9; color: #000;">‚ò∞</button>
                <b style="font-size:18px">Latiao</b>
            </div>
            <div style="display:flex; gap:10px">
                <button class="btn" style="background:none" onclick="nav('support')">–ß–∞—Ç–∏</button>
                <button class="btn" id="nav-set" style="background:none; display:none" onclick="nav('settings')">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                <button class="btn" style="color:red; background:none" onclick="logout()">–í–∏—Ö—ñ–¥</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar" id="sidebar">
                <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; gap:8px">
                    <button class="btn" style="flex:1; font-size:12px; background:#eee" onclick="setMode('active')">–ê–∫—Ç–∏–≤–Ω—ñ</button>
                    <button class="btn" style="flex:1; font-size:12px; background:#eee" onclick="setMode('archived')">–ê—Ä—Ö—ñ–≤</button>
                </div>
                <div class="chat-list" id="chat-list"></div>
            </aside>

            <main class="content">
                <section id="view-support" class="tab-content" style="display:flex">
                    <div class="messages" id="m-area"></div>
                    <div class="chat-input-area">
                        <div class="scripts-row" id="scripts-bar"></div>
                        <form class="input-group" onsubmit="send(event)">
                            <input type="text" id="msg-in" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
                            <button type="submit" class="btn btn-primary btn-icon">‚û§</button>
                        </form>
                    </div>
                </section>

                <section id="view-settings" class="tab-content" style="display:none" class="settings-container">
                    <div class="settings-container">
                        <h2 style="margin-bottom:30px">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏</h2>
                        <div class="settings-grid">
                            <div class="settings-card">
                                <h3>üß§ –ú–µ–Ω–µ–¥–∂–µ—Ä–∏</h3>
                                <div id="mgr-admin-list" style="margin-bottom:15px"></div>
                                <div style="display:flex; flex-direction:column; gap:8px">
                                    <input type="text" id="nm" placeholder="–Ü–º'—è">
                                    <input type="text" id="nl" placeholder="–õ–æ–≥—ñ–Ω">
                                    <input type="text" id="np" placeholder="–ü–∞—Ä–æ–ª—å">
                                    <button class="btn btn-primary" onclick="addM()">–î–æ–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø</button>
                                </div>
                            </div>
                            <div class="settings-card">
                                <h3>‚ö° –°–∫—Ä—ñ–ø—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</h3>
                                <div id="scripts-admin-list" style="margin-bottom:15px"></div>
                                <div style="display:flex; flex-direction:column; gap:8px">
                                    <input type="text" id="stitle" placeholder="–ù–∞–∑–≤–∞ –∫–Ω–æ–ø–∫–∏">
                                    <textarea id="stext" placeholder="–¢–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ"></textarea>
                                    <button class="btn btn-primary" onclick="addScript()">–ó–±–µ—Ä–µ–≥—Ç–∏ —Å–∫—Ä—ñ–ø—Ç</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
            <div id="mgr-options" style="display:flex; flex-direction:column; gap:8px"></div>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('user'));
    let curId = null, mode = 'active', managers = {};
    const sounds = { click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'), send: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3') };

    function initAudio() { Object.values(sounds).forEach(s => { s.play().then(()=>s.pause()); }); }
    function playS(t) { sounds[t].currentTime=0; sounds[t].play().catch(()=>{}); }

    function login() {
        const l=document.getElementById('al').value, p=document.getElementById('ap').value;
        if(l==='admin' && p==='latiao2024') return logOk({name:'–í–ª–∞—Å–Ω–∏–∫', role:'admin', id:'admin'});
        db.ref('managers').once('value', snap => {
            snap.forEach(m => {
                const d=m.val();
                if(d.login===l && d.pass===p) logOk({name:d.name, role:'manager', id:m.key});
            });
        });
    }
    function logOk(d) { localStorage.setItem('user', JSON.stringify(d)); location.reload(); }
    function logout() { localStorage.clear(); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('crm-ui').style.display='flex';
        if(user.role === 'admin') document.getElementById('nav-set').style.display='block';
        init();
    }

    function init() {
        db.ref('managers').on('value', snap => { 
            managers = snap.val() || {}; 
            renderSettings();
            loadList(); 
        });
        db.ref('active_chats').on('value', () => loadList());
        db.ref('config/scripts').on('value', snap => {
            const sc = snap.val() || {};
            const bar = document.getElementById('scripts-bar');
            bar.innerHTML = '';
            Object.keys(sc).forEach(k => {
                const s = sc[k];
                const div = document.createElement('div');
                div.className = 'script-badge';
                div.innerText = s.title;
                div.onclick = () => { document.getElementById('msg-in').value = s.text; playS('click'); };
                bar.appendChild(div);
            });
            renderSettings();
        });
    }

    function loadList() {
        const path = mode==='active'?'active_chats':'closed_chats';
        db.ref(path).once('value', snap => {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                if(user.role==='manager' && d.assignedTo && d.assignedTo !== user.id) return;

                const div = document.createElement('div');
                div.className = `chat-card ${curId===c.key?'active':''}`;
                const mName = d.assignedTo==='admin'?'–í–ª–∞—Å–Ω–∏–∫':(managers[d.assignedTo]?.name || '‚Äî');

                div.innerHTML = `
                    <div style="font-weight:700">üë§ ${c.key.substring(0,10)}</div>
                    <div style="font-size:12px; color:var(--text-secondary); margin:4px 0">${d.lastMsg || '...'}</div>
                    <div class="badge-mgr">üß§ ${mName}</div>
                    <button onclick="event.stopPropagation(); openAssign('${c.key}')" style="position:absolute; right:10px; top:10px; border:none; background:none; cursor:pointer; font-size:18px">üë§</button>
                `;
                div.onclick = () => { curId=c.key; openChat(c.key); if(window.innerWidth < 850) toggleSidebar(); };
                list.appendChild(div);
            });
        });
    }

    function openChat(id) {
        db.ref('support/'+id).on('value', snap => {
            const area = document.getElementById('m-area'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                area.innerHTML += `<div class="msg ${d.type==='sys'?'sys':(d.type==='out'?'out':'in')}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
        loadList();
    }

    function send(e) {
        e.preventDefault(); const i=document.getElementById('msg-in');
        if(!curId || !i.value) return;
        db.ref('support/'+curId).push({text: i.value, type:'out', ts: Date.now()});
        db.ref('active_chats/'+curId).update({lastMsg: "–í–∏: "+i.value});
        i.value=''; playS('send');
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
    
    function nav(id) {
        document.getElementById('view-support').style.display = id==='support'?'flex':'none';
        document.getElementById('view-settings').style.display = id==='settings'?'block':'none';
    }

    function openAssign(cid) {
        document.getElementById('modal-overlay').style.display='flex';
        const opt = document.getElementById('mgr-options'); opt.innerHTML = '';
        const addOpt = (name, id) => {
            const b = document.createElement('button'); b.className = 'btn';
            b.style.background = '#f1f5f9'; b.innerText = name;
            b.onclick = () => {
                db.ref('active_chats/'+cid).update({assignedTo: id});
                db.ref('support/'+cid).push({text: `üß§ –ü–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ: ${name}`, type:'sys'});
                closeModal();
            };
            opt.appendChild(b);
        };
        addOpt('üëë –í–ª–∞—Å–Ω–∏–∫', 'admin');
        Object.keys(managers).forEach(id => addOpt('üß§ ' + managers[id].name, id));
    }

    function closeModal() { document.getElementById('modal-overlay').style.display='none'; }
    function setMode(m) { mode=m; loadList(); }

    // Admin Settings Logic
    function renderSettings() {
        if(user.role !== 'admin') return;
        const mList = document.getElementById('mgr-admin-list'); mList.innerHTML = '';
        Object.keys(managers).forEach(id => {
            mList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; background:#f8fafc; border-radius:8px; margin-bottom:5px; font-size:13px">
                ${managers[id].name} <span onclick="db.ref('managers/${id}').remove()" style="color:red; cursor:pointer">–í–∏–¥–∞–ª–∏—Ç–∏</span>
            </div>`;
        });
        const sList = document.getElementById('scripts-admin-list'); sList.innerHTML = '';
        db.ref('config/scripts').once('value', snap => {
            snap.forEach(s => {
                sList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; background:#f8fafc; border-radius:8px; margin-bottom:5px; font-size:13px">
                    ${s.val().title} <span onclick="db.ref('config/scripts/${s.key}').remove()" style="color:red; cursor:pointer">–í–∏–¥–∞–ª–∏—Ç–∏</span>
                </div>`;
            });
        });
    }

    function addM() {
        const n=document.getElementById('nm').value, l=document.getElementById('nl').value, p=document.getElementById('np').value;
        if(n && l && p) db.ref('managers').push({name:n, login:l, pass:p});
    }

    function addScript() {
        const t=document.getElementById('stitle').value, txt=document.getElementById('stext').value;
        if(t && txt) db.ref('config/scripts').push({title:t, text:txt});
    }
</script>
</body>
</html>
