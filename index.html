<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao CRM | Management Panel</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #e62117;
            --primary-light: #fff1f0;
            --bg: #f8fafc;
            --sidebar: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --radius: 16px;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--text-main);
            overflow: hidden;
        }

        /* –°—Ç–æ—Ä—ñ–Ω–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex; align-items: center; justify-content: center; z-index: 10000;
        }
        .auth-card {
            background: #fff; padding: 40px; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.05); width: 100%; max-width: 400px;
            text-align: center; border: 1px solid #fff;
        }
        .auth-card h2 { margin-bottom: 30px; font-weight: 800; color: var(--primary); }
        .auth-input {
            width: 100%; padding: 14px 20px; border-radius: 12px;
            border: 1px solid var(--border); margin-bottom: 15px; outline: none;
            transition: 0.3s; font-size: 16px;
        }
        .auth-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
        .auth-btn {
            width: 100%; padding: 14px; border-radius: 12px; border: none;
            background: var(--primary); color: #fff; font-weight: 700;
            cursor: pointer; transition: 0.3s; font-size: 16px;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(230,33,23,0.2); }

        /* CRM –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #crm-app { display: none; height: 100vh; flex-direction: row; }

        .sidebar {
            width: 320px; background: var(--sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 100;
        }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 20px; color: var(--primary); }
        
        .chat-filters { display: flex; padding: 15px 20px; gap: 10px; border-bottom: 1px solid var(--border); }
        .filter-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: none;
            background: #f1f5f9; color: var(--text-sub); font-weight: 700; font-size: 12px;
            cursor: pointer; transition: 0.2s;
        }
        .filter-btn.active { background: var(--primary-light); color: var(--primary); }

        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-card {
            padding: 16px; border-radius: var(--radius); cursor: pointer;
            transition: 0.2s; margin-bottom: 8px; border: 1px solid transparent;
        }
        .chat-card:hover { background: #f1f5f9; }
        .chat-card.active { background: var(--primary-light); border-color: #fee2e2; }
        .chat-card strong { display: block; font-size: 14px; margin-bottom: 4px; }
        .chat-card small { color: var(--text-sub); font-size: 12px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .main-header { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        .msg-area { 
            flex: 1; padding: 30px; overflow-y: auto; background: #f8fafc;
            display: flex; flex-direction: column; gap: 12px;
        }
        .bubble {
            padding: 12px 18px; border-radius: 18px; max-width: 70%; font-size: 14px;
            line-height: 1.5; position: relative;
        }
        .bubble.user { align-self: flex-start; background: #fff; border: 1px solid var(--border); color: var(--text-main); }
        .bubble.admin { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 4px; }

        .input-area { padding: 20px 30px; border-top: 1px solid var(--border); display: flex; gap: 15px; }
        .input-area input {
            flex: 1; padding: 14px 24px; border-radius: 30px;
            border: 1px solid var(--border); outline: none; background: #f1f5f9;
        }
        .send-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: var(--primary); color: #fff; cursor: pointer; font-size: 18px;
        }

        .tab-btn {
            padding: 10px 20px; border: none; background: none; font-weight: 700;
            color: var(--text-sub); cursor: pointer; font-size: 14px;
        }
        .tab-btn.active { color: var(--primary); }

        @media (max-width: 768px) {
            .sidebar { width: 80px; }
            .logo span, .chat-card strong, .chat-card small, .filter-btn span { display: none; }
            .chat-card { text-align: center; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <div class="logo" style="justify-content: center; margin-bottom: 20px;">üöÄ Latiao CRM</div>
            <h2>–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <input type="text" id="login-field" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="pass-field" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="tryLogin()">–£–≤—ñ–π—Ç–∏</button>
            <p id="error-msg" style="color: var(--primary); font-size: 14px; margin-top: 15px; display: none;">–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å</p>
        </div>
    </div>

    <div id="crm-app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">üöÄ <span>Latiao CRM</span></div>
            </div>
            <div class="chat-filters">
                <button class="filter-btn active" onclick="toggleList('active', this)"><span>–ê–∫—Ç–∏–≤–Ω—ñ</span></button>
                <button class="filter-btn" onclick="toggleList('closed', this)"><span>–ê—Ä—Ö—ñ–≤</span></button>
            </div>
            <div id="chat-list" class="chat-list"></div>
            <div style="padding: 20px; border-top: 1px solid var(--border);">
                <button class="nav-link" onclick="logout()" style="color: var(--text-sub); border:none; background:none; cursor:pointer; font-weight:600;">–í—ã–π—Ç–∏</button>
            </div>
        </aside>

        <main class="main">
            <div class="main-header">
                <div id="current-chat-title" style="font-weight: 800;">–û–±–µ—Ä—ñ—Ç—å –¥—ñ–∞–ª–æ–≥</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-action" onclick="requestPhone()" style="background: none; border: 1px solid var(--border); padding: 8px 15px; border-radius: 8px; cursor: pointer;">üìû –¢–µ–ª–µ—Ñ–æ–Ω</button>
                    <button class="btn-action" onclick="archiveChat()" style="background: var(--primary-light); border: none; color: var(--primary); padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 700;">–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏</button>
                </div>
            </div>

            <div id="msg-area" class="msg-area"></div>

            <form class="input-area" onsubmit="sendReply(event)">
                <input type="text" id="admin-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
                <button type="submit" class="send-btn">‚û§</button>
            </form>
        </main>
    </div>

    <script>
        // --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó ---
        const ADMIN_USER = "admin";
        const ADMIN_PASS = "latiao2025";

        function tryLogin() {
            const l = document.getElementById('login-field').value;
            const p = document.getElementById('pass-field').value;
            if(l === ADMIN_USER && p === ADMIN_PASS) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('crm-app').style.display = 'flex';
                localStorage.setItem('crm_logged', 'true');
                initFirebase();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        if(localStorage.getItem('crm_logged') === 'true') {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('crm-app').style.display = 'flex';
        }

        function logout() {
            localStorage.removeItem('crm_logged');
            location.reload();
        }

        // --- Firebase –õ–æ–≥—ñ–∫–∞ ---
        const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
        
        function initFirebase() {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            let currentId = null;
            let currentMode = 'active';

            window.toggleList = function(mode, btn) {
                currentMode = mode;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadChats();
            }

            function loadChats() {
                const path = currentMode === 'active' ? 'active_chats' : 'closed_chats';
                db.ref(path).on('value', snap => {
                    const list = document.getElementById('chat-list');
                    list.innerHTML = '';
                    snap.forEach(child => {
                        const div = document.createElement('div');
                        div.className = `chat-card ${currentId === child.key ? 'active' : ''}`;
                        div.innerHTML = `<strong>ID: ${child.key.substring(1, 10)}</strong><small>${child.val().lastMsg || '...'}</small>`;
                        div.onclick = () => selectChat(child.key);
                        list.appendChild(div);
                    });
                });
            }

            function selectChat(id) {
                currentId = id;
                document.getElementById('current-chat-title').innerText = "–î—ñ–∞–ª–æ–≥: " + id.substring(1, 10);
                const path = currentMode === 'active' ? 'support/' : 'archive/';
                db.ref(path + id).on('value', snap => {
                    const area = document.getElementById('msg-area');
                    area.innerHTML = '';
                    snap.forEach(m => {
                        const data = m.val();
                        const div = document.createElement('div');
                        div.className = 'bubble ' + data.type;
                        div.innerText = data.text;
                        area.appendChild(div);
                    });
                    area.scrollTop = area.scrollHeight;
                });
                loadChats();
            }

            window.sendReply = function(e) {
                e.preventDefault();
                const input = document.getElementById('admin-input');
                if(!currentId || !input.value.trim()) return;
                db.ref('support/' + currentId).push({ text: input.value, type: 'admin', ts: Date.now() });
                db.ref('active_chats/' + currentId).update({ lastMsg: "–í–∏: " + input.value, ts: Date.now() });
                input.value = '';
            }

            window.archiveChat = function() {
                if(!currentId) return;
                db.ref('support/' + currentId).once('value', snap => {
                    db.ref('archive/' + currentId).set(snap.val());
                    db.ref('closed_chats/' + currentId).set({ ts: Date.now(), lastMsg: "–ê—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ" });
                    db.ref('support/' + currentId).remove();
                    db.ref('active_chats/' + currentId).remove();
                    currentId = null;
                    document.getElementById('msg-area').innerHTML = '';
                    loadChats();
                });
            }

            window.requestPhone = function() {
                if(currentId) db.ref('support/' + currentId).push({ text: "–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ª–∏—à—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –∑–≤'—è–∑–∫—É:", type: 'admin', ts: Date.now() });
            }

            loadChats();
        }

        if(localStorage.getItem('crm_logged') === 'true') initFirebase();
    </script>
</body>
</html>
