<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM | Smart Queue & Telegram ‚ùÑÔ∏è</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #e62117; --accent-glow: rgba(230, 33, 23, 0.12); --border: #e8eaed; --gold: #ffd700; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #dfe1e5; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Auth */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1470&auto=format&fit=crop'); background-size: cover; z-index: 999999; display: flex; align-items: center; justify-content: center; }
        .auth-card { width: 350px; background: #fff; padding: 30px; border-radius: 25px; text-align: center; border: 2px solid var(--gold); }
        .input-std { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #ddd; }
        .btn-red { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }

        /* UI */
        #crm-ui { display: none; height: 100%; flex-direction: column; }
        .header { display: flex; align-items: flex-end; padding: 8px 12px 0; background: #dfe1e5; border-bottom: 1px solid #c1c3c8; gap: 5px; }
        .tab { padding: 10px 20px; background: transparent; border-radius: 12px 12px 0 0; cursor: pointer; font-size: 13px; font-weight: 600; color: #555; }
        .tab.active { background: #fff; color: var(--accent); }
        
        .main { flex: 1; display: flex; background: #fff; overflow: hidden; }
        .sidebar { width: 340px; border-right: 1px solid var(--border); background: #f8f9fa; display: flex; flex-direction: column; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .chat-item { padding: 12px; border-radius: 15px; margin-bottom: 8px; border: 1px solid #eee; background: #fff; cursor: pointer; position: relative; }
        .chat-item.active-chat { border-color: var(--accent); background: var(--accent-glow); }
        .tag { position: absolute; top: 10px; right: 10px; font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #007aff; color: #fff; }

        .viewport { flex: 1; display: flex; flex-direction: column; }
        .msgs { flex: 1; padding: 15px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 14px; border-radius: 18px; max-width: 80%; font-size: 14px; }
        .bubble.in { align-self: flex-start; background: #fff; }
        .bubble.out { align-self: flex-end; background: var(--accent); color: #fff; }
        .bubble.sys { align-self: center; background: #cbd5e1; font-size: 10px; font-weight: 800; }

        .footer { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .footer input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; }

        .mgr-row { background: #f1f3f4; padding: 10px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color:var(--accent)">Latiao CRM ‚ùÑÔ∏è</h2>
            <input type="text" id="l" class="input-std" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="p" class="input-std" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-red" onclick="login()">–£–í–Ü–ô–¢–ò</button>
        </div>
    </div>

    <div id="crm-ui">
        <header class="header">
            <div class="tab active" onclick="nav('support', this)">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ <b id="cnt">0</b></div>
            <div id="t-set" class="tab" onclick="nav('settings', this)">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
        </header>

        <div class="main">
            <aside class="sidebar">
                <div style="padding:15px; font-weight:800; font-size:12px; color:#666;" id="hi"></div>
                <div id="chat-list" class="chat-list"></div>
                <button onclick="localStorage.clear();location.reload()" style="padding:15px; color:red; border:none; background:none; cursor:pointer; font-weight:bold;">üö™ –í–∏–π—Ç–∏</button>
            </aside>

            <main class="viewport view-tab active" id="view-support">
                <div id="support-msgs" class="msgs"></div>
                <div class="footer">
                    <input type="text" id="m-in" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                    <button class="btn-red" style="width:60px" onclick="send()">‚û§</button>
                </div>
            </main>

            <main class="viewport view-tab" id="view-settings" style="display:none; padding:20px; overflow-y:auto">
                <div style="max-width:600px">
                    <h3>üë• –ú–µ–Ω–µ–¥–∂–µ—Ä–∏ —Ç–∞ –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
                    <div id="m-list"></div>
                    <div style="background:#fff; padding:15px; border-radius:20px; border:1px solid #eee">
                        <input type="text" id="mn" class="input-std" placeholder="–Ü–º'—è">
                        <input type="text" id="ml" class="input-std" placeholder="–õ–æ–≥—ñ–Ω">
                        <input type="text" id="mp" class="input-std" placeholder="–ü–∞—Ä–æ–ª—å">
                        <input type="text" id="mtg" class="input-std" placeholder="Telegram Chat ID (–¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å)">
                        <button class="btn-red" onclick="addM()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
    const BOT_TOKEN = "8538208852:AAFASKSeci30FVNU5sPl3vkmVSPLcfWFqEI";
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('user'));
    let curId = null, managers = {};

    function login() {
        const l=document.getElementById('l').value, p=document.getElementById('p').value;
        if(l==='admin' && p==='latiao2024') return loginOk({name:'–ë–æ—Å—Å', role:'admin', id:'admin'});
        db.ref('managers').once('value', snap => {
            snap.forEach(m => {
                const d=m.val();
                if(d.login===l && d.pass===p) loginOk({name:d.name, role:'manager', id:m.key, tgId: d.tgId});
            });
        });
    }

    function loginOk(d) { localStorage.setItem('user', JSON.stringify(d)); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('crm-ui').style.display='flex';
        document.getElementById('hi').innerText = `–í—ñ—Ç–∞—î–º–æ, ${user.name}! üéÑ`;
        if(user.role !== 'admin') document.getElementById('t-set').style.display='none';
        init();
    }

    function init() {
        db.ref('managers').on('value', snap => { managers = snap.val() || {}; if(user.role==='admin') renderMgrs(); });
        
        db.ref('active_chats').on('value', snap => {
            document.getElementById('cnt').innerText = snap.numChildren();
            processQueue(snap.val());
            renderList(snap.val());
        });

        // –ü–ï–†–ï–í–Ü–†–ö–ê –¢–ê–ô–ú–ï–†–Ü–í (Escalation) –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
        setInterval(checkEscalation, 30000);
    }

    // SMART DISPATCHER
    function processQueue(chats) {
        if(!chats) return;
        const hr = new Date().getHours();
        if(hr >= 0 && hr < 8) return; // –ù—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º - –±–µ–∑ –∞–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è

        const mgrIds = Object.keys(managers).filter(id => managers[id].tgId); // –¢—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ –∑ TG
        if(mgrIds.length === 0) return;

        Object.keys(chats).forEach(id => {
            const chat = chats[id];
            if(!chat.assignedTo) {
                const randomId = mgrIds[Math.floor(Math.random() * mgrIds.length)];
                assign(id, randomId, "–ê–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏");
            }
        });
    }

    function checkEscalation() {
        const now = Date.now();
        db.ref('active_chats').once('value', snap => {
            snap.forEach(c => {
                const d = c.val();
                if(d.assignedTo && d.assignedTo !== 'admin' && d.lastClientMsgTs) {
                    const diff = (now - d.lastClientMsgTs) / 1000 / 60;
                    if(diff > 5) { // 5 —Ö–≤–∏–ª–∏–Ω –±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                        console.log("Escalation for " + c.key);
                        assign(c.key, 'admin', "‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ 5—Ö–≤! –ü–µ—Ä–µ–¥–∞–Ω–æ –í–ª–∞—Å–Ω–∏–∫—É");
                    }
                }
            });
        });
    }

    function assign(chatId, mgrId, reason) {
        const name = mgrId === 'admin' ? '–í–ª–∞—Å–Ω–∏–∫' : managers[mgrId].name;
        const tgId = mgrId === 'admin' ? "558890365" : managers[mgrId].tgId;

        db.ref('active_chats/' + chatId).update({ assignedTo: mgrId, assignedAt: Date.now() });
        db.ref('support/' + chatId).push({ text: `‚ö° ${reason}: ${name}`, type: 'sys', ts: Date.now() });

        // –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ TG
        if(tgId) {
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: tgId,
                    text: `üõéÔ∏è –ù–û–í–ò–ô –ß–ê–¢ –ü–†–ò–ó–ù–ê–ß–ï–ù–û!\n–ö–ª—ñ—î–Ω—Ç: ${chatId.substring(0,8)}\n–ü—Ä–∏—á–∏–Ω–∞: ${reason}`
                })
            });
        }
    }

    function renderList(chats) {
        const list = document.getElementById('chat-list'); list.innerHTML = '';
        if(!chats) return;
        Object.keys(chats).forEach(id => {
            const d = chats[id];
            if(user.role === 'manager' && d.assignedTo !== user.id) return;

            const div = document.createElement('div');
            div.className = `chat-item ${curId===id?'active-chat':''}`;
            const mName = d.assignedTo === 'admin' ? '–ë–æ—Å—Å' : (managers[d.assignedTo]?.name || '–í—ñ–ª—å–Ω–∏–π');
            div.innerHTML = `<strong>üë§ ${id.substring(0,8)}</strong><br><small>${d.lastMsg||'...'}</small>
                             <span class="tag">${mName}</span>`;
            div.onclick = () => { curId = id; openChat(id); };
            list.appendChild(div);
        });
    }

    function openChat(id) {
        db.ref('support/'+id).on('value', snap => {
            const area = document.getElementById('support-msgs'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                area.innerHTML += `<div class="bubble ${d.type}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function send() {
        const i = document.getElementById('m-in');
        if(!curId || !i.value) return;
        db.ref('support/'+curId).push({ text: i.value, type: 'out', ts: Date.now() });
        db.ref('active_chats/'+curId).update({ lastMsg: "–ú–µ–Ω–µ–¥–∂–µ—Ä: " + i.value, lastClientMsgTs: null });
        i.value = '';
    }

    // –°–ª—É—Ö–∞—î–º–æ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
    db.ref('active_chats').on('child_changed', snap => {
        const d = snap.val();
        if(d.lastMsg && !d.lastMsg.includes("–ú–µ–Ω–µ–¥–∂–µ—Ä:")) {
            db.ref('active_chats/' + snap.key).update({ lastClientMsgTs: Date.now() });
        }
    });

    function addM() {
        const n=document.getElementById('mn').value, l=document.getElementById('ml').value, 
              p=document.getElementById('mp').value, tg=document.getElementById('mtg').value;
        if(n && l && p) db.ref('managers').push({name:n, login:l, pass:p, tgId:tg});
    }

    function renderMgrs() {
        const l=document.getElementById('m-list'); l.innerHTML='';
        Object.keys(managers).forEach(id => {
            l.innerHTML += `<div class="mgr-row">
                <span><b>${managers[id].name}</b> (TG: ${managers[id].tgId || '‚Äî'})</span>
                <button onclick="db.ref('managers/${id}').remove()" style="color:red;border:none;background:none;cursor:pointer">‚úï</button>
            </div>`;
        });
    }

    function nav(t, el) {
        document.querySelectorAll('.view-tab').forEach(v=>v.style.display='none');
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.getElementById('view-'+t).style.display='flex';
        el.classList.add('active');
    }
</script>
</body>
</html>
