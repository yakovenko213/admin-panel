<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao Ultimate CRM 2025</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e62117; --bg: #f8f9fa; --sidebar: #ffffff; --border: #e4e6eb; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: #1c1e21; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); text-align: center; }
        .nav-link { padding: 12px 20px; cursor: pointer; border: none; background: none; text-align: left; font-weight: 600; width: 100%; transition: 0.2s; color: #65676b; }
        .nav-link.active { background: #fff1f0; color: var(--primary); border-left: 4px solid var(--primary); }
        
        /* Chat List & Filters */
        .chat-filters { display: flex; border-bottom: 1px solid var(--border); }
        .filter-btn { flex: 1; padding: 10px; border: none; background: none; font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; color: #888; }
        .filter-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .chat-scroll { flex: 1; overflow-y: auto; }
        .chat-card { padding: 15px; border-bottom: 1px solid #f0f2f5; cursor: pointer; }
        .chat-card.active { background: #fef2f2; }
        .chat-card .time { float: right; font-size: 10px; color: #999; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* Messaging */
        .msg-area { flex: 1; padding: 20px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 8px; }
        .scm { padding: 10px 14px; border-radius: 18px; max-width: 70%; position: relative; font-size: 14px; }
        .scm span { display: block; font-size: 9px; margin-top: 4px; opacity: 0.6; }
        .scm.user { align-self: flex-start; background: #fff; border: 1px solid #ddd; }
        .scm.admin { align-self: flex-end; background: var(--primary); color: #fff; }
        
        /* Controls */
        .chat-controls { padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; }
        .btn-action { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: #fff; font-size: 12px; cursor: pointer; font-weight: 600; }
        .btn-action:hover { border-color: var(--primary); color: var(--primary); }

        /* Tables & Cards */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px; }
        .stat-box { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-box h4 { margin: 0; color: #888; font-size: 11px; text-transform: uppercase; }
        .stat-box p { margin: 10px 0 0; font-size: 24px; font-weight: 800; color: var(--primary); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header"><h3>LATIAO CRM</h3></div>
        <div class="nav-menu">
            <button class="nav-link active" onclick="switchTab('chats')">üí¨ –ß–∞—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</button>
            <button class="nav-link" onclick="switchTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="nav-link" onclick="switchTab('contacts')">üë• –ë–∞–∑–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤</button>
        </div>
        
        <div class="chat-filters">
            <button class="filter-btn active" id="f-open" onclick="toggleChatList('active')">–í—ñ–¥–∫—Ä–∏—Ç—ñ</button>
            <button class="filter-btn" id="f-closed" onclick="toggleChatList('closed')">–ó–∞–∫—Ä–∏—Ç—ñ</button>
        </div>
        <div id="chat-list" class="chat-scroll"></div>
    </aside>

    <main class="main">
        <section id="tab-chats" class="tab-content active">
            <div class="chat-controls">
                <button class="btn-action" onclick="requestPhone()">üìû –ó–∞–ø–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω—É</button>
                <button class="btn-action" style="margin-left: auto;" onclick="closeChat()">üîí –ó–∞–∫—Ä–∏—Ç–∏ —á–∞—Ç</button>
            </div>
            <div id="msg-area" class="msg-area"></div>
            <form style="padding: 20px; display: flex; gap: 10px;" onsubmit="sendReply(event)">
                <input type="text" id="admin-reply" style="flex:1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none;" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                <button type="submit" style="background:var(--primary); color:#fff; border:none; padding:10px 25px; border-radius:20px; cursor:pointer; font-weight:bold;">‚û§</button>
            </form>
        </section>

        <section id="tab-stats" class="tab-content" style="padding: 30px; overflow-y: auto;">
            <h2>–ó–≤—ñ—Ç–Ω—ñ—Å—Ç—å</h2>
            <div class="stat-grid">
                <div class="stat-box"><h4>–í—Å—å–æ–≥–æ –∑–≤–µ—Ä–Ω–µ–Ω—å</h4><p id="st-total">0</p></div>
                <div class="stat-box"><h4>Ghost (–±–µ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)</h4><p id="st-ghost">0</p></div>
                <div class="stat-box"><h4>–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞</h4><p id="st-rate">0.0</p></div>
                <div class="stat-box"><h4>–ö–æ–Ω—Ç–∞–∫—Ç—ñ–≤ –∑—ñ–±—Ä–∞–Ω–æ</h4><p id="st-contacts">0</p></div>
            </div>
            <h3>–û—Å—Ç–∞–Ω–Ω—ñ –æ—Ü—ñ–Ω–∫–∏</h3>
            <div id="ratings-log"></div>
        </section>

        <section id="tab-contacts" class="tab-content" style="padding: 30px; overflow-y: auto;">
            <h2>–ë–∞–∑–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤ —Ç–∞ UTM</h2>
            <table class="data-table">
                <thead>
                    <tr><th>–ö–ª—ñ—î–Ω—Ç ID</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>UTM / –î–∂–µ—Ä–µ–ª–æ</th><th>–î–∞—Ç–∞</th></tr>
                </thead>
                <tbody id="contacts-body"></tbody>
            </table>
        </section>
    </main>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentId = null;
    let listFilter = 'active';

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        event.currentTarget.classList.add('active');
        if(tab === 'stats') loadStats();
        if(tab === 'contacts') loadContacts();
    }

    function toggleChatList(status) {
        listFilter = status;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('f-' + (status === 'active' ? 'open' : 'closed')).classList.add('active');
        loadChats();
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤
    function loadChats() {
        const path = listFilter === 'active' ? 'active_chats' : 'closed_chats';
        db.ref(path).on('value', snap => {
            const container = document.getElementById('chat-list');
            container.innerHTML = '';
            snap.forEach(child => {
                const c = child.val();
                const div = document.createElement('div');
                div.className = `chat-card ${currentId === child.key ? 'active' : ''}`;
                const time = new Date(c.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                div.innerHTML = `<span class="time">${time}</span><strong>${child.key.substring(1, 8)}</strong><br><small>${c.lastMsg || '...'}</small>`;
                div.onclick = () => selectChat(child.key);
                container.appendChild(div);
            });
        });
    }

    function selectChat(id) {
        currentId = id;
        loadChats(); // –æ–Ω–æ–≤–∏—Ç–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∫—É
        const path = listFilter === 'active' ? 'support/' : 'archive/';
        db.ref(path + id).on('value', snap => {
            const area = document.getElementById('msg-area');
            area.innerHTML = '';
            snap.forEach(m => {
                const data = m.val();
                const div = document.createElement('div');
                div.className = 'scm ' + data.type;
                const time = new Date(data.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                div.innerHTML = `${data.text} <span>${time}</span>`;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendReply(e) {
        e.preventDefault();
        const input = document.getElementById('admin-reply');
        if(!currentId || !input.value.trim() || listFilter === 'closed') return;
        
        const text = input.value;
        const ts = Date.now();
        db.ref('support/' + currentId).push({ text, type: 'admin', ts });
        db.ref('active_chats/' + currentId).update({ lastMsg: "–í–∏: " + text, ts });
        input.value = '';
    }

    function closeChat() {
        if(!currentId || listFilter === 'closed') return;
        if(confirm('–ó–∞–∫—Ä–∏—Ç–∏ –¥—ñ–∞–ª–æ–≥ —ñ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∞—Ä—Ö—ñ–≤?')) {
            db.ref('support/' + currentId).once('value', snap => {
                db.ref('archive/' + currentId).set(snap.val());
                db.ref('closed_chats/' + currentId).set({ ts: Date.now(), lastMsg: "–ß–∞—Ç –∑–∞–∫—Ä–∏—Ç–æ" });
                db.ref('support/' + currentId).remove();
                db.ref('active_chats/' + currentId).remove();
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ –æ—Ü—ñ–Ω–∫—É
                db.ref('archive/' + currentId).push({ 
                    text: "–ß–∞—Ç –∑–∞–∫—Ä–∏—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º. –û—Ü—ñ–Ω—ñ—Ç—å —è–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ 1 –¥–æ 5:", 
                    type: 'admin', ts: Date.now() 
                });
                currentId = null;
                document.getElementById('msg-area').innerHTML = '';
            });
        }
    }

    function requestPhone() {
        if(!currentId) return;
        const text = "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –Ω–∞–ø–∏—à—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É:";
        db.ref('support/' + currentId).push({ text, type: 'admin', ts: Date.now() });
    }

    function loadStats() {
        db.ref('stats/ghost_opens').once('value', s => document.getElementById('st-ghost').innerText = s.val() || 0);
        db.ref('active_chats').once('value', s => document.getElementById('st-total').innerText = s.numChildren());
        db.ref('contacts').once('value', s => document.getElementById('st-contacts').innerText = s.numChildren());
        db.ref('ratings').once('value', snap => {
            let sum = 0, count = 0, html = '';
            snap.forEach(r => {
                sum += parseInt(r.val().stars); count++;
                html += `<div style="padding:10px; border-bottom:1px solid #eee">ID: ${r.key} - <b>${r.val().stars}‚≠ê</b></div>`;
            });
            document.getElementById('st-rate').innerText = count > 0 ? (sum/count).toFixed(1) : "0.0";
            document.getElementById('ratings-log').innerHTML = html;
        });
    }

    function loadContacts() {
        db.ref('contacts').on('value', snap => {
            const body = document.getElementById('contacts-body');
            body.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                body.innerHTML += `<tr>
                    <td>${c.key}</td>
                    <td><b>${d.phone || '‚Äî'}</b></td>
                    <td><small>${d.utm || 'Direct'}</small></td>
                    <td>${new Date(d.ts).toLocaleDateString()}</td>
                </tr>`;
            });
        });
    }

    loadChats();
</script>
</body>
</html>
