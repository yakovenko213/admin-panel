<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao CRM PRO | Multi-Chat Control</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e62117; --primary-light: #fff1f0; --bg: #f8fafc; --sidebar: #ffffff; --text-main: #0f172a; --text-sub: #64748b; --border: #e2e8f0; --radius: 16px; --blue: #007aff; --gold: #ffb900; }
        * { box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: var(--bg); color: var(--text-main); overflow: hidden; height: 100vh; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: #f8fafc; display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .auth-card { background: #fff; padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        .auth-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; outline: none; }
        .auth-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-weight: 700; cursor: pointer; }

        /* Layout */
        #crm-app { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid var(--border); font-weight: 800; color: var(--primary); font-size: 18px; }
        
        .nav-menu { padding: 10px; flex: 1; overflow-y: auto; }
        .nav-link { padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 600; color: var(--text-sub); display: flex; align-items: center; gap: 10px; transition: 0.2s; margin-bottom: 4px; }
        .nav-link:hover { background: #f1f5f9; }
        .nav-link.active { background: var(--primary-light); color: var(--primary); }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
        .tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* Messaging Area */
        .chat-header { padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .msg-area { flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 16px; border-radius: 18px; max-width: 75%; font-size: 14px; line-height: 1.4; }
        .bubble.user { align-self: flex-start; background: #fff; border: 1px solid var(--border); }
        .bubble.admin { align-self: flex-end; background: var(--primary); color: #fff; }
        .bubble.shop { align-self: center; background: var(--gold); color: #000; font-weight: bold; border-radius: 10px; }
        
        /* Community Tab Specifics */
        .community-container { display: flex; height: 100%; }
        .comm-chat { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .comm-tools { width: 300px; background: #fafbfc; padding: 20px; overflow-y: auto; }
        .tool-box { background: #fff; border: 1px solid var(--border); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .tool-box h4 { margin: 0 0 10px 0; font-size: 13px; text-transform: uppercase; color: var(--text-sub); }
        .comm-user-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        
        /* Inputs */
        .input-form { padding: 15px 25px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .input-form input { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid var(--border); outline: none; background: #f1f5f9; }
        .btn-sm { padding: 4px 8px; border-radius: 6px; border: none; font-size: 10px; font-weight: 800; cursor: pointer; color: #fff; }
        .btn-primary { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 700; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2>Latiao CRM –í—Ö—ñ–¥</h2>
            <input type="text" id="login-field" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="pass-field" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="tryLogin()">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

    <div id="crm-app">
        <aside class="sidebar">
            <div class="sidebar-header">LATIAO CRM PRO</div>
            <nav class="nav-menu">
                <div class="nav-link active" onclick="switchTab('support', this)">üí¨ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ (1:1)</div>
                <div class="nav-link" onclick="switchTab('community', this)">üå∂Ô∏è –°–ø—ñ–ª—å–Ω–æ—Ç–∞ (–ó–∞–≥–∞–ª—å–Ω–∏–π)</div>
                <div class="nav-link" onclick="switchTab('stats', this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            </nav>
            <div id="support-chat-list" style="padding: 10px; border-top: 1px solid #eee; overflow-y:auto; flex:1;"></div>
        </aside>

        <main class="main">
            <section id="tab-support" class="tab-content active">
                <div class="chat-header">
                    <b id="support-title">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞</b>
                    <button class="btn-sm" style="background:var(--primary)" onclick="archiveSupport()">–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏</button>
                </div>
                <div id="support-msgs" class="msg-area"></div>
                <form class="input-form" onsubmit="sendSupportMsg(event)">
                    <input type="text" id="support-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç—É...">
                    <button type="submit" class="btn-primary">‚û§</button>
                </form>
            </section>

            <section id="tab-community" class="tab-content">
                <div class="community-container">
                    <div class="comm-chat">
                        <div class="chat-header"><b>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –°–ø—ñ–ª—å–Ω–æ—Ç–∏</b></div>
                        <div id="comm-msgs" class="msg-area"></div>
                        <form class="input-form" onsubmit="sendCommMsg(event)">
                            <input type="text" id="comm-input" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ SHOP...">
                            <button type="submit" class="btn-primary">‚û§</button>
                        </form>
                    </div>
                    <div class="comm-tools">
                        <div class="tool-box">
                            <h4>üì¢ –†–µ–∫–ª–∞–º–∞ (SHOP)</h4>
                            <input type="text" id="ad-img" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏" style="width:100%; margin-bottom:5px; font-size:11px; padding:5px;">
                            <textarea id="ad-text" placeholder="–¢–µ–∫—Å—Ç —Ä–µ–∫–ª–∞–º–∏..." style="width:100%; height:60px; font-size:11px; padding:5px; border-radius:8px; border:1px solid #ddd;"></textarea>
                            <button class="btn-primary" style="width:100%; margin-top:5px; font-size:11px;" onclick="postAd()">–ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
                        </div>
                        <div class="tool-box">
                            <h4>üìä –û–ø–∏—Ç—É–≤–∞–Ω–Ω—è</h4>
                            <input type="text" id="poll-q" placeholder="–ü–∏—Ç–∞–Ω–Ω—è" style="width:100%; margin-bottom:5px; font-size:11px; padding:5px;">
                            <button class="btn-primary" style="width:100%; font-size:11px;" onclick="postPoll()">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                        </div>
                        <div class="tool-box">
                            <h4>üë• –Æ–∑–µ—Ä–∏ –æ–Ω–ª–∞–π–Ω</h4>
                            <div id="comm-user-list"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
    // Config & Login
    const config = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(config);
    const db = firebase.database();
    
    function tryLogin() {
        const l = document.getElementById('login-field').value;
        const p = document.getElementById('pass-field').value;
        if(l === 'admin' && p === 'latiao2025') {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('crm-app').style.display = 'flex';
            initCRM();
        }
    }

    function switchTab(tab, el) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');
        el.classList.add('active');
    }

    let currentSupportId = null;

    function initCRM() {
        // 1. SUPPORT CHATS LIST
        db.ref('active_chats').on('value', snap => {
            const list = document.getElementById('support-chat-list');
            list.innerHTML = '<small style="color:#999">–ê–ö–¢–ò–í–ù–Ü –î–Ü–ê–õ–û–ì–ò</small>';
            snap.forEach(child => {
                const div = document.createElement('div');
                div.className = 'nav-link';
                div.style.fontSize = '12px';
                div.innerHTML = `üë§ ${child.key.substring(0,8)}...`;
                div.onclick = () => selectSupportChat(child.key);
                list.appendChild(div);
            });
        });

        // 2. COMMUNITY MONITORING
        db.ref('messages').limitToLast(30).on('value', snap => {
            const area = document.getElementById('comm-msgs');
            area.innerHTML = '';
            snap.forEach(child => {
                const m = child.val();
                const div = document.createElement('div');
                div.className = m.uid === 'SHOP' ? 'bubble shop' : 'bubble user';
                div.innerHTML = `<small style="display:block; font-size:9px; opacity:0.6">${m.name || '–Æ–∑–µ—Ä'}</small>${m.text}`;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });

        // 3. COMMUNITY USERS
        db.ref('presence').on('value', snap => {
            const list = document.getElementById('comm-user-list');
            list.innerHTML = '';
            snap.forEach(child => {
                const u = child.val();
                const div = document.createElement('div');
                div.className = 'comm-user-item';
                div.innerHTML = `<span>${u.name || '–ì—ñ—Å—Ç—å'}</span>
                    <div style="display:flex; gap:2px">
                        <button class="btn-sm" style="background:var(--blue)" onclick="sendPrivate('${child.key}')">‚úâÔ∏è</button>
                        <button class="btn-sm" style="background:var(--gold)" onclick="reqPhone('${child.key}')">üì±</button>
                        <button class="btn-sm" style="background:var(--primary)" onclick="banUser('${child.key}')">üö´</button>
                    </div>`;
                list.appendChild(div);
            });
        });
    }

    // SUPPORT ACTIONS
    function selectSupportChat(id) {
        currentSupportId = id;
        document.getElementById('support-title').innerText = "–ö–ª—ñ—î–Ω—Ç: " + id;
        db.ref('support/' + id).on('value', snap => {
            const area = document.getElementById('support-msgs');
            area.innerHTML = '';
            snap.forEach(child => {
                const m = child.val();
                const div = document.createElement('div');
                div.className = 'bubble ' + m.type;
                div.innerText = m.text;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendSupportMsg(e) {
        e.preventDefault();
        const input = document.getElementById('support-input');
        if(!currentSupportId || !input.value) return;
        db.ref('support/' + currentSupportId).push({ text: input.value, type: 'admin', ts: Date.now() });
        input.value = '';
    }

    // COMMUNITY ACTIONS
    function sendCommMsg(e) {
        e.preventDefault();
        const input = document.getElementById('comm-input');
        if(!input.value) return;
        db.ref('messages').push({ uid: 'SHOP', name: 'SHOP ADMIN', text: input.value, ts: Date.now() });
        input.value = '';
    }

    function postAd() {
        const text = document.getElementById('ad-text').value;
        const img = document.getElementById('ad-img').value;
        if(text) db.ref('messages').push({ uid: 'SHOP', name: 'üõçÔ∏è Latiao PROMO', text: text, img: img, ts: Date.now() });
    }

    function postPoll() {
        const q = document.getElementById('poll-q').value;
        if(q) db.ref('polls').push({ question: q, o1: '–¢–ê–ö üî•', o2: '–ù–Ü üå∂Ô∏è', v1: 0, v2: 0, ts: Date.now() });
    }

    // USER MGMT
    window.sendPrivate = (uid) => {
        const msg = prompt("–ü—Ä–∏–≤–∞—Ç–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:");
        if(msg) db.ref('private_messages/' + uid).push({ text: msg, ts: Date.now() });
    }

    window.reqPhone = (uid) => {
        if(confirm("–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É?")) {
            db.ref('presence/' + uid).update({ requirePhone: true, phoneProvided: false });
        }
    }

    window.banUser = (uid) => {
        if(confirm("–ó–∞–±–∞–Ω–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?")) {
            db.ref('banned_users/' + uid).set({ ts: Date.now() });
        }
    }
</script>
</body>
</html>
