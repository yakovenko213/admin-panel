<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM PRO | Ultimate Sync</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #e62117; --accent-glow: rgba(230, 33, 23, 0.12); --chrome-bg: #dfe1e5; --chrome-tab: #ffffff; --sidebar-bg: #f8f9fa; --border: #e8eaed; --info: #007aff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--chrome-bg); display: flex; flex-direction: column; }

        /* AUTH SECTION */
        #auth-screen { position: fixed; inset: 0; background: #fff; z-index: 999999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 350px; text-align: center; }
        .auth-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 14px; background: #000; color: #fff; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }

        /* CRM UI */
        #crm-ui { display: none; height: 100%; flex-direction: column; }
        .chrome-header { display: flex; align-items: flex-end; padding: 8px 8px 0; gap: 4px; background: var(--chrome-bg); border-bottom: 1px solid #c1c3c8; flex-shrink: 0; }
        .tab { position: relative; padding: 10px 15px; min-width: 60px; height: 38px; background: transparent; border-radius: 12px 12px 0 0; cursor: pointer; font-size: 13px; font-weight: 600; color: #5f6368; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab.active { background: var(--chrome-tab); color: var(--accent); }
        .tab.active::before { content: ''; position: absolute; bottom: 0; left: -15px; width: 15px; height: 15px; border-bottom-right-radius: 10px; box-shadow: 5px 0 0 0 var(--chrome-tab); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; right: -15px; width: 15px; height: 15px; border-bottom-left-radius: 10px; box-shadow: -5px 0 0 0 var(--chrome-tab); }
        @media (min-width: 768px) { .tab { min-width: 160px; justify-content: flex-start; } .tab span { display: inline; } }

        .app-shell { flex: 1; display: flex; background: #fff; overflow: hidden; position: relative; }
        .viewport { flex: 1; display: flex; flex-direction: column; background: #fff; height: 100%; border-right: 1px solid var(--border); }
        .msg-area { flex: 1; padding: 15px; overflow-y: auto; background: #f4f6f8; display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; line-height: 1.4; position: relative; }
        .bubble.in { align-self: flex-start; background: #fff; border: 1px solid #eee; }
        .bubble.out { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.private-out { align-self: flex-end; background: var(--info); color: #fff; border-bottom-right-radius: 4px; font-weight: 600; }

        /* QUICK SCRIPTS */
        .scripts-bar { display: flex; gap: 8px; overflow-x: auto; padding: 10px 15px; background: #fff; border-top: 1px solid var(--border); scrollbar-width: none; }
        .script-btn { flex-shrink: 0; padding: 8px 16px; background: #f1f3f4; border: 1px solid #ddd; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; }

        .footer { padding: 12px 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #fff; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .footer input { flex: 1; height: 44px; padding: 0 18px; border-radius: 22px; border: 1px solid #eee; background: #f5f5f5; font-size: 16px; }

        /* USERS LIST IN COMMUNITY */
        .users-side { width: 320px; background: #fdfdfd; padding: 15px; overflow-y: auto; }
        .u-card { background: #fff; border: 1px solid var(--border); border-radius: 18px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .u-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .u-avatar { width: 40px; height: 40px; background: #eee; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; position: relative; }
        .u-dot { width: 10px; height: 10px; border-radius: 50%; position: absolute; bottom: -2px; right: -2px; border: 2px solid #fff; }
        .u-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .u-btn { border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 12px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2>Latiao CRM</h2>
            <input type="text" id="auth-login" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="tryLogin()">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

    <div id="crm-ui">
        <header class="chrome-header">
            <div class="tab active" onclick="nav('community', this)"><i>üå∂Ô∏è</i> <span>–ó–∞–≥–∞–ª—å–Ω–∏–π –ß–∞—Ç</span></div>
            <div class="tab" onclick="nav('support', this)"><i>üí¨</i> <span>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</span> <div id="b-total" style="margin-left:5px; font-size:10px; font-weight:900;">0</div></div>
            <div class="tab" onclick="nav('settings', this)"><i>‚öôÔ∏è</i> <span>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></div>
        </header>

        <div class="greeting-bar" id="greeting-text"></div>

        <div class="app-shell">
            <main class="viewport view-tab active" id="view-community" style="flex-direction: row;">
                <div style="flex:1; display:flex; flex-direction:column; border-right:1px solid #eee;">
                    <div class="top-nav"><b>Live Community</b></div>
                    <div class="msg-area" id="comm-msgs"></div>
                    <div class="scripts-bar" id="comm-scripts"></div>
                    <form class="footer" onsubmit="sendC(event)">
                        <input type="text" id="c-input" placeholder="–í—ñ–¥ —ñ–º–µ–Ω—ñ SHOP..." autocomplete="off">
                        <button type="submit" style="background:#000; color:#fff; border:none; width:44px; height:44px; border-radius:50%;">‚û§</button>
                    </form>
                </div>
                <div class="users-side">
                    <h4 style="font-size:11px; color:#888; margin-bottom:15px;">–£–ß–ê–°–ù–ò–ö–ò –û–ù–õ–ê–ô–ù</h4>
                    <div id="u-cards-list"></div>
                </div>
            </main>

            <main class="viewport view-tab" id="view-support" style="display:none;">
                <div style="display:flex; height:100%;">
                    <div style="width:300px; border-right:1px solid #eee; overflow-y:auto; padding:10px;" id="support-sidebar">
                        <div id="active-chats-list"></div>
                    </div>
                    <div style="flex:1; display:flex; flex-direction:column;">
                        <div class="top-nav"><b id="s-chat-name">–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç</b></div>
                        <div class="msg-area" id="support-msgs"></div>
                        <div class="scripts-bar" id="support-scripts"></div>
                        <form class="footer" onsubmit="sendS(event)">
                            <input type="text" id="s-input" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                            <button type="submit" style="background:#000; color:#fff; border:none; width:44px; height:44px; border-radius:50%;">‚û§</button>
                        </form>
                    </div>
                </div>
            </main>

            <main class="viewport view-tab" id="view-settings" style="display:none; padding:20px; overflow-y:auto;">
                <div style="max-width:600px; margin:0 auto;">
                    <div class="u-card" id="mgr-mgmt-box">
                        <h4>üë• –ú–µ–Ω–µ–¥–∂–µ—Ä–∏</h4>
                        <div id="mgr-list"></div>
                        <input type="text" id="mgr-name" class="auth-input" placeholder="–Ü–º'—è">
                        <input type="text" id="mgr-log" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
                        <input type="text" id="mgr-pas" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <button class="auth-btn" onclick="addManager()">–î–æ–¥–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
                    </div>

                    <div class="u-card">
                        <h4>üìù –°–∫—Ä–∏–ø—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</h4>
                        <div id="script-edit-list"></div>
                        <button class="auth-btn" style="background:#007aff" onclick="addScriptRow()">+ –î–æ–¥–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç</button>
                        <button class="auth-btn" style="margin-top:10px" onclick="saveScripts()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ —Å–∫—Ä–∏–ø—Ç–∏</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('crm_user'));
    let curSId = null, scripts = [];

    // AUTH
    function tryLogin() {
        const l = document.getElementById('auth-login').value;
        const p = document.getElementById('auth-pass').value;
        if(l === 'admin' && p === 'latiao2024') return loginOk({name: '–í–ª–∞—Å–Ω–∏–∫', role: 'owner'});
        
        db.ref('managers').once('value', snap => {
            let found = false;
            snap.forEach(m => {
                const d = m.val();
                if(d.login === l && d.pass === p) { loginOk({name: d.name, role: 'manager'}); found = true; }
            });
            if(!found) alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É');
        });
    }

    function loginOk(d) {
        localStorage.setItem('crm_user', JSON.stringify(d));
        user = d;
        location.reload();
    }

    function logout() { localStorage.removeItem('crm_user'); location.reload(); }

    // INITIALIZATION
    if(user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('crm-ui').style.display = 'flex';
        const hr = new Date().getHours();
        const gr = hr < 12 ? "–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É" : hr < 18 ? "–î–æ–±—Ä–æ–≥–æ –¥–Ω—è" : "–î–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞";
        document.getElementById('greeting-text').innerText = `${gr}, ${user.name}!`;
        if(user.role !== 'owner') document.getElementById('mgr-mgmt-box').classList.add('hidden');
        initSync();
    }

    function initSync() {
        // COMMUNITY MESSAGES SYNC
        db.ref('messages').limitToLast(50).on('value', snap => {
            const area = document.getElementById('comm-msgs'); area.innerHTML = '';
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div');
                div.className = `bubble ${m.uid==='SHOP'?'out':'in'}`;
                div.style.alignSelf = m.uid==='SHOP'?'flex-end':'flex-start';
                div.innerHTML = `<small style="display:block;font-size:9px;opacity:0.5">${m.name}</small>
                                 ${m.img ? `<img src="${m.img}" style="max-width:100%;border-radius:10px;margin:5px 0;">` : ''}
                                 ${m.text}`;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });

        // USERS SYNC
        db.ref('presence').on('value', snap => {
            const list = document.getElementById('u-cards-list'); list.innerHTML = '';
            snap.forEach(c => {
                const u = c.val();
                const color = u.phoneProvided ? '#34c759' : u.requirePhone ? '#ffb900' : '#ccc';
                list.innerHTML += `<div class="u-card">
                    <div class="u-info">
                        <div class="u-avatar">${(u.name||'?')[0]}<div class="u-dot" style="background:${color}"></div></div>
                        <div><b>${u.name||'–ì—ñ—Å—Ç—å'}</b><br><small>${u.phone||'–ù–µ–º–∞—î –Ω–æ–º–µ—Ä–∞'}</small></div>
                    </div>
                    <div class="u-actions">
                        <button class="u-btn" style="background:#eef7ff" onclick="sendPriv('${c.key}')">‚úâÔ∏è</button>
                        <button class="u-btn" style="background:#fff9e6" onclick="reqPhone('${c.key}')">üì±</button>
                        <button class="u-btn" style="background:#fff0f0" onclick="banU('${c.key}')">üö´</button>
                    </div>
                </div>`;
            });
        });

        // SCRIPTS SYNC
        db.ref('config/scripts').on('value', snap => {
            scripts = snap.val() || [];
            renderScripts();
            renderScriptEdit();
        });

        // SUPPORT CHATS SYNC
        db.ref('active_chats').on('value', snap => {
            const list = document.getElementById('active-chats-list'); list.innerHTML = '';
            document.getElementById('b-total').innerText = snap.numChildren();
            snap.forEach(c => {
                const d = c.val();
                list.innerHTML += `<div class="u-card" onclick="openS('${c.key}')" style="cursor:pointer; ${curSId===c.key?'border-color:var(--accent)':''}">
                    <b>${c.key.substring(0,10)}</b><br><small>${d.lastMsg||'...'}</small>
                </div>`;
            });
        });
    }

    function nav(t, el) {
        document.querySelectorAll('.view-tab').forEach(v => v.style.display='none');
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.getElementById('view-'+t).style.display = (t==='support'?'flex':'flex');
        if(t==='community') document.getElementById('view-community').style.display='flex';
        el.classList.add('active');
    }

    // ACTIONS
    function sendC(e) { e.preventDefault(); const i=document.getElementById('c-input'); if(i.value) db.ref('messages').push({uid:'SHOP', name:'SHOP', text:i.value, ts:Date.now()}); i.value=''; }
    
    function sendPriv(uid) { const m=prompt("–ü—Ä–∏–≤–∞—Ç–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:"); if(m) db.ref('private_messages/'+uid).push({text:m, ts:Date.now()}); }
    
    function reqPhone(uid) { db.ref('presence/'+uid).update({requirePhone:true, phoneProvided:false}); }
    
    function banU(uid) { if(confirm("–ó–∞–±–∞–Ω–∏—Ç–∏?")) db.ref('banned_users/'+uid).set(true); }

    function openS(id) {
        curSId = id; document.getElementById('s-chat-name').innerText = "–ß–∞—Ç: "+id;
        db.ref('support/'+id).on('value', snap => {
            const area = document.getElementById('support-msgs'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                area.innerHTML += `<div class="bubble ${d.type==='admin'?'out':'in'}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendS(e) { e.preventDefault(); const i=document.getElementById('s-input'); if(curSId && i.value) { db.ref('support/'+curSId).push({text:i.value, type:'admin', ts:Date.now()}); db.ref('active_chats/'+curSId).update({lastMsg:"–í–∏: "+i.value}); i.value=''; } }

    // SCRIPTS LOGIC
    function renderScripts() {
        const bars = [document.getElementById('comm-scripts'), document.getElementById('support-scripts')];
        bars.forEach(b => {
            b.innerHTML = '';
            scripts.forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'script-btn';
                btn.innerText = s.title;
                btn.onclick = () => { const inp = b.nextElementSibling.querySelector('input'); inp.value = s.text; inp.focus(); };
                b.appendChild(btn);
            });
        });
    }

    function renderScriptEdit() {
        const list = document.getElementById('script-edit-list'); list.innerHTML = '';
        scripts.forEach((s, i) => {
            list.innerHTML += `<div style="margin-bottom:10px; padding:10px; border:1px solid #eee; border-radius:10px;">
                <input class="auth-input" value="${s.title}" onchange="scripts[${i}].title=this.value">
                <textarea class="auth-input" onchange="scripts[${i}].text=this.value">${s.text}</textarea>
                <button onclick="scripts.splice(${i},1);renderScriptEdit()" style="color:red;border:none;background:none;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>`;
        });
    }
    function addScriptRow() { scripts.push({title:'–ù–æ–≤–∏–π', text:''}); renderScriptEdit(); }
    function saveScripts() { db.ref('config/scripts').set(scripts).then(()=>alert("–ó–±–µ—Ä–µ–∂–µ–Ω–æ")); }

    // MANAGERS
    function addManager() {
        const n=document.getElementById('mgr-name').value, l=document.getElementById('mgr-log').value, p=document.getElementById('mgr-pas').value;
        if(n && l && p) db.ref('managers').push({name:n, login:l, pass:p});
    }
    function loadManagers() {
        db.ref('managers').on('value', snap => {
            const list = document.getElementById('mgr-list'); list.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                list.innerHTML += `<div class="manager-row"><b>${d.name}</b> (${d.login}) <button onclick="db.ref('managers/${m.key}').remove()">‚úï</button></div>`;
            });
        });
    }
</script>
</body>
</html>
