<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM Ultimate PRO | Full Control ‚ùÑÔ∏è</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #e62117; --accent-glow: rgba(230, 33, 23, 0.12); --chrome-bg: #dfe1e5; --chrome-tab: #ffffff; --sidebar-bg: #f8f9fa; --border: #e8eaed; --gold: #ffd700; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--chrome-bg); display: flex; flex-direction: column; }

        /* SNOW */
        .snowflake { position: fixed; top: -10%; z-index: 9999; color: #fff; font-size: 1em; user-select: none; pointer-events: none; animation: snow-fall 10s linear infinite; }
        @keyframes snow-fall { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1470&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: 999999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 360px; text-align: center; background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 2px solid var(--gold); position: relative; }
        .auth-card::before { content: 'üéÑ'; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 50px; }
        .auth-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 12px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; }

        /* CRM UI */
        #crm-ui { display: none; height: 100%; flex-direction: column; position: relative; }
        .christmas-decor { position: absolute; top: 0; left: 0; width: 100%; height: 50px; background: url('https://www.transparentpng.com/download/christmas-decoration/pine-branches-with-ornaments-christmas-decoration-png-19.png'); background-size: contain; background-repeat: repeat-x; z-index: 1001; pointer-events: none; opacity: 0.8; }
        
        .chrome-header { display: flex; align-items: flex-end; padding: 8px 8px 0; gap: 4px; background: var(--chrome-bg); border-bottom: 1px solid #c1c3c8; flex-shrink: 0; z-index: 1002; }
        .tab { position: relative; padding: 10px 15px; min-width: 60px; height: 38px; background: transparent; border-radius: 12px 12px 0 0; cursor: pointer; font-size: 13px; font-weight: 600; color: #5f6368; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab.active { background: var(--chrome-tab); color: var(--accent); }
        @media (min-width: 768px) { .tab { min-width: 160px; justify-content: flex-start; } .tab span { display: inline; } }

        .app-shell { flex: 1; display: flex; background: #fff; overflow: hidden; position: relative; }
        
        /* SIDEBAR & ADAPTIVE */
        .sidebar { width: 100%; height: 100%; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: absolute; z-index: 100; transition: transform 0.3s ease; }
        .sidebar.hidden { transform: translateX(-100%); }
        @media (min-width: 992px) { .sidebar { position: relative; width: 340px; transform: none !important; } }

        /* CHAT LIST */
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 12px; border-radius: 15px; margin-bottom: 8px; background: #fff; border: 1px solid #eee; cursor: pointer; position: relative; }
        .chat-item.active-chat { border-color: var(--accent); background: var(--accent-glow); }
        .tag-mgr { position: absolute; top: 10px; right: 10px; font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #007aff; color: #fff; }

        /* VIEWPORT */
        .viewport { flex: 1; display: flex; flex-direction: column; background: #fff; height: 100%; }
        .top-nav { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; background: #fff; }
        
        .msg-area { flex: 1; padding: 15px; overflow-y: auto; background: #f4f6f8; display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; }
        .bubble.in { align-self: flex-start; background: #fff; border: 1px solid #eee; }
        .bubble.out { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.sys { align-self: center; background: #cbd5e1; font-size: 10px; font-weight: 800; color: #1e293b; border-radius: 8px; }

        .scripts-bar { display: flex; gap: 8px; overflow-x: auto; padding: 10px; background: #fff; border-top: 1px solid var(--border); scrollbar-width: none; }
        .script-btn { flex-shrink: 0; padding: 8px 14px; background: #f1f3f4; border-radius: 10px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1px solid #ddd; }

        .footer { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #fff; }
        .footer input { flex: 1; height: 44px; padding: 0 18px; border-radius: 22px; border: 1px solid #eee; background: #f5f5f5; font-size: 16px; }

        .settings-area { padding: 20px; overflow-y: auto; height: 100%; background: #f9f9fb; }
        .set-card { background: #fff; border-radius: 20px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; }
        .hidden-tab { display: none !important; }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color:var(--accent)">Latiao CRM</h2>
            <p style="color:#666; font-size:13px; margin-bottom:20px;">üéÑ –ó–∏–º–æ–≤–∏–π –°–µ–∑–æ–Ω 2026 ‚ùÑÔ∏è</p>
            <input type="text" id="auth-l" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="auth-p" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="tryLogin()">–£–í–Ü–ô–¢–ò</button>
        </div>
    </div>

    <div id="crm-ui">
        <div class="christmas-decor"></div>
        <header class="chrome-header">
            <div class="tab active" onclick="nav('support', this)"><i>üí¨</i> <span>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</span> <b id="chat-count" style="margin-left:5px">0</b></div>
            <div id="t-comm" class="tab" onclick="nav('community', this)"><i>üå∂Ô∏è</i> <span>–°–ø—ñ–ª—å–Ω–æ—Ç–∞</span></div>
            <div id="t-set" class="tab" onclick="nav('settings', this)"><i>‚öôÔ∏è</i> <span>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></div>
        </header>

        <div class="app-shell">
            <aside class="sidebar" id="side-panel">
                <div style="padding:15px; border-bottom:1px solid #eee; background:#fff;">
                    <div id="greeting-txt" style="font-weight:800; font-size:12px; color:#1a1a1a;"></div>
                    <div style="display:flex; gap:5px; margin-top:10px">
                        <button class="auth-btn" style="padding:5px; font-size:10px; flex:1" onclick="setMode('active')">–ê–ö–¢–ò–í–ù–Ü</button>
                        <button class="auth-btn" style="padding:5px; font-size:10px; flex:1; background:#666" onclick="setMode('archived')">–ê–†–•–Ü–í</button>
                    </div>
                </div>
                <div id="chat-list" class="chat-list"></div>
                <button onclick="logout()" style="padding:15px; color:red; border:none; background:none; font-weight:bold; cursor:pointer;">üö™ –í–∏–π—Ç–∏</button>
            </aside>

            <main class="viewport view-tab active" id="view-support">
                <div class="top-nav">
                    <button class="auth-btn" style="width:35px; height:35px; padding:0; background:#000;" onclick="document.getElementById('side-panel').classList.remove('hidden')">‚Äπ</button>
                    <b id="active-user-name" style="font-size:14px">–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç</b>
                    <button style="margin-left:auto; border:none; background:none; color:var(--accent); font-weight:800; cursor:pointer;" onclick="archiveChat()">–ó–ê–ö–†–ò–¢–ò</button>
                </div>
                <div class="msg-area" id="support-msgs"></div>
                <div id="scripts-chat-bar" class="scripts-bar"></div>
                <form class="footer" onsubmit="sendMsg(event)">
                    <input type="text" id="msg-input" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                    <button type="submit" style="background:#000; color:#fff; border:none; width:44px; height:44px; border-radius:50%; cursor:pointer;">‚û§</button>
                </form>
            </main>

            <main class="viewport view-tab" id="view-settings" style="display:none;">
                <div class="settings-area">
                    <div class="set-card" id="admin-only-mgr">
                        <h4>üë• –ú–µ–Ω–µ–¥–∂–µ—Ä–∏ —Ç–∞ Telegram ID</h4>
                        <div id="mgr-list"></div>
                        <hr>
                        <input type="text" id="n-m-name" class="auth-input" placeholder="–Ü–º'—è">
                        <input type="text" id="n-m-log" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
                        <input type="text" id="n-m-pas" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <input type="text" id="n-m-tg" class="auth-input" placeholder="Telegram Chat ID">
                        <button class="auth-btn" onclick="addMgr()">–î–æ–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø</button>
                    </div>
                    <div class="set-card">
                        <h4>ü§ñ FAQ (–í—ñ–¥–∂–µ—Ç –∫–ª—ñ—î–Ω—Ç–∞)</h4>
                        <div id="faq-editor"></div>
                        <button class="auth-btn" style="background:#007aff" onclick="addFAQRow()">+ –î–æ–¥–∞—Ç–∏ FAQ</button>
                        <button class="auth-btn" style="margin-top:10px" onclick="saveCfg('faq')">–ó–±–µ—Ä–µ–≥—Ç–∏ FAQ</button>
                    </div>
                    <div class="set-card">
                        <h4>üìù –°–∫—Ä–∏–ø—Ç–∏ (–®–≤–∏–¥–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ)</h4>
                        <div id="script-editor"></div>
                        <button class="auth-btn" style="background:#007aff" onclick="addScriptRow()">+ –î–æ–¥–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç</button>
                        <button class="auth-btn" style="margin-top:10px" onclick="saveCfg('scripts')">–ó–±–µ—Ä–µ–≥—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∏</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
    const BOT_TOKEN = "8538208852:AAFASKSeci30FVNU5sPl3vkmVSPLcfWFqEI";
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('user'));
    let curId = null, mode = 'active', managers = {}, scripts = [], faqs = [];

    // SNOW
    for(let i=0;i<25;i++){
        let s=document.createElement('div'); s.className='snowflake'; s.innerHTML='‚ùÑ';
        s.style.left=Math.random()*100+'vw'; s.style.animationDuration=(Math.random()*5+5)+'s';
        document.getElementById('snow-container').appendChild(s);
    }

    function tryLogin() {
        const l=document.getElementById('auth-l').value, p=document.getElementById('auth-p').value;
        if(l==='admin' && p==='latiao2024') return loginOk({name:'–ë–æ—Å—Å', role:'admin', id:'admin', tgId:'558890365'});
        db.ref('managers').once('value', snap => {
            let f=false;
            snap.forEach(m => {
                const d=m.val();
                if(d.login===l && d.pass===p) { loginOk({name:d.name, role:'manager', id:m.key, tgId:d.tgId}); f=true; }
            });
            if(!f) alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É');
        });
    }

    function loginOk(d) { localStorage.setItem('user', JSON.stringify(d)); location.reload(); }
    function logout() { localStorage.clear(); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('crm-ui').style.display='flex';
        const hr = new Date().getHours();
        const gr = hr<12?"–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É":hr<18?"–î–æ–±—Ä–æ–≥–æ –¥–Ω—è":"–î–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞";
        document.getElementById('greeting-txt').innerText = `${gr}, ${user.name}! üéÑ`;
        if(user.role !== 'admin') {
            document.getElementById('t-comm').style.display='none';
            document.getElementById('t-set').style.display='none';
        }
        init();
    }

    function init() {
        db.ref('managers').on('value', snap => { 
            managers = snap.val() || {}; 
            if(user.role==='admin') renderMgrList(); 
            loadList(); 
        });

        db.ref('config').on('value', snap => {
            const cfg = snap.val() || {};
            scripts = cfg.scripts || [];
            faqs = cfg.faq || [];
            renderScriptsInChat();
            if(user.role==='admin') renderCfgEditors();
        });

        db.ref('active_chats').on('value', snap => {
            document.getElementById('chat-count').innerText = snap.numChildren();
            smartAssign(snap.val());
            loadList();
        });

        setInterval(checkEscalation, 60000); // 1—Ö–≤ —á–µ–∫
    }

    // SMART ASSIGN & ESCALATION
    function smartAssign(chats) {
        if(!chats) return;
        const hr = new Date().getHours();
        if(hr >= 0 && hr < 8) return; // –ù—ñ—á

        const available = Object.keys(managers).filter(id => managers[id].tgId);
        if(user.role==='admin') available.push('admin');
        if(available.length === 0) return;

        Object.keys(chats).forEach(cid => {
            if(!chats[cid].assignedTo) {
                const rand = available[Math.floor(Math.random() * available.length)];
                assign(cid, rand, "–ê–≤—Ç–æ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è");
            }
        });
    }

    function checkEscalation() {
        const now = Date.now();
        db.ref('active_chats').once('value', snap => {
            snap.forEach(c => {
                const d = c.val();
                if(d.assignedTo && d.assignedTo !== 'admin' && d.lastClientMsgTs) {
                    if((now - d.lastClientMsgTs) > 300000) { // 5 —Ö–≤
                        assign(c.key, 'admin', "‚ö†Ô∏è –ï—Å–∫–∞–ª–∞—Ü—ñ—è (5—Ö–≤ –±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ)");
                    }
                }
            });
        });
    }

    function assign(cid, mid, reason) {
        const name = mid==='admin'?'–ë–æ—Å—Å':managers[mid].name;
        const tg = mid==='admin'?'558890365':managers[mid].tgId;
        db.ref('active_chats/'+cid).update({ assignedTo: mid, assignedAt: Date.now() });
        db.ref('support/'+cid).push({ text: `üß§ ${reason}: ${name}`, type: 'sys', ts: Date.now() });
        if(tg) fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({chat_id: tg, text: `üîî –ù–û–í–ò–ô –ß–ê–¢!\n–ö–ª—ñ—î–Ω—Ç: ${cid.substring(0,8)}\n${reason}`})
        });
    }

    // CRM LOGIC
    function loadList() {
        const path = mode==='active'?'active_chats':'closed_chats';
        db.ref(path).once('value', snap => {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                if(user.role==='manager' && d.assignedTo && d.assignedTo !== user.id) return;
                
                const div = document.createElement('div');
                div.className = `chat-item ${curId===c.key?'active-chat':''}`;
                const mName = d.assignedTo==='admin'?'–ë–æ—Å—Å':(managers[d.assignedTo]?.name || '‚Äî');
                div.innerHTML = `<strong>üë§ ${c.key.substring(0,8)}</strong><br><small>${d.lastMsg||'...'}</small>
                                 ${d.assignedTo?`<span class="tag-mgr">${mName}</span>`:''}`;
                
                if(user.role==='admin') {
                    const sel = document.createElement('select');
                    sel.innerHTML = `<option value="">–ü–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏...</option><option value="admin">–ë–æ—Å—Å</option>`;
                    Object.keys(managers).forEach(mId => sel.innerHTML += `<option value="${mId}">${managers[mId].name}</option>`);
                    sel.onchange = (e) => assign(c.key, e.target.value, "–ü–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –í–ª–∞—Å–Ω–∏–∫–æ–º");
                    sel.onclick = (e) => e.stopPropagation();
                    div.appendChild(sel);
                }
                div.onclick = () => { curId=c.key; openChat(c.key); if(window.innerWidth<992) document.getElementById('side-panel').classList.add('hidden'); };
                list.appendChild(div);
            });
        });
    }

    function openChat(id) {
        document.getElementById('active-user-name').innerText = "–ö–ª—ñ—î–Ω—Ç: " + id.substring(0,8);
        const path = mode==='active'?'support/':'archive/';
        db.ref(path+id).on('value', snap => {
            const area = document.getElementById('support-msgs'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                area.innerHTML += `<div class="bubble ${d.type}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendMsg(e) {
        e.preventDefault(); const i = document.getElementById('msg-input');
        if(!curId || !i.value) return;
        db.ref('support/'+curId).push({ text: i.value, type: 'out', ts: Date.now() });
        db.ref('active_chats/'+curId).update({ lastMsg: "–ú–µ–Ω–µ–¥–∂–µ—Ä: "+i.value, lastClientMsgTs: null });
        i.value = '';
    }

    function renderScriptsInChat() {
        const bar = document.getElementById('scripts-chat-bar'); bar.innerHTML = '';
        scripts.forEach(s => {
            const btn = document.createElement('button'); btn.className = 'script-btn'; btn.innerText = s.title;
            btn.onclick = () => { document.getElementById('msg-input').value = s.text; document.getElementById('msg-input').focus(); };
            bar.appendChild(btn);
        });
    }

    // SETTINGS RENDERERS
    function renderCfgEditors() {
        const faqArea = document.getElementById('faq-editor'); faqArea.innerHTML = '';
        faqs.forEach((f, i) => {
            faqArea.innerHTML += `<div class="auth-input" style="height:auto; margin-bottom:10px;">
                <input class="auth-input" value="${f.q}" onchange="faqs[${i}].q=this.value" placeholder="–ü–∏—Ç–∞–Ω–Ω—è">
                <textarea class="auth-input" onchange="faqs[${i}].a=this.value">${f.a}</textarea>
                <button onclick="faqs.splice(${i},1);renderCfgEditors()" style="color:red;border:none;background:none;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>`;
        });
        const scrArea = document.getElementById('script-editor'); scrArea.innerHTML = '';
        scripts.forEach((s, i) => {
            scrArea.innerHTML += `<div class="auth-input" style="height:auto; margin-bottom:10px;">
                <input class="auth-input" value="${s.title}" onchange="scripts[${i}].title=this.value" placeholder="–ù–∞–∑–≤–∞">
                <textarea class="auth-input" onchange="scripts[${i}].text=this.value">${s.text}</textarea>
                <button onclick="scripts.splice(${i},1);renderCfgEditors()" style="color:red;border:none;background:none;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>`;
        });
    }

    function renderMgrList() {
        const list = document.getElementById('mgr-list'); list.innerHTML = '';
        Object.keys(managers).forEach(id => {
            list.innerHTML += `<div class="manager-row" style="background:#f1f3f4; padding:10px; border-radius:10px; margin-bottom:5px; display:flex; justify-content:space-between;">
                <span><b>${managers[id].name}</b> (TG: ${managers[id].tgId})</span>
                <button onclick="db.ref('managers/${id}').remove()" style="color:red; border:none; background:none;">‚úï</button>
            </div>`;
        });
    }

    function addFAQRow() { faqs.push({q:'', a:''}); renderCfgEditors(); }
    function addScriptRow() { scripts.push({title:'', text:''}); renderCfgEditors(); }
    function saveCfg(type) { db.ref('config/'+type).set(type==='faq'?faqs:scripts).then(()=>alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ!')); }
    function addMgr() {
        const n=document.getElementById('n-m-name').value, l=document.getElementById('n-m-log').value, 
              p=document.getElementById('n-m-pas').value, t=document.getElementById('n-m-tg').value;
        if(n && l && p) db.ref('managers').push({name:n, login:l, pass:p, tgId:t});
    }

    function nav(t, el) {
        document.querySelectorAll('.view-tab').forEach(v=>v.style.display='none');
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.getElementById('view-'+t).style.display='flex'; el.classList.add('active');
        if(t==='support') document.getElementById('side-panel').style.display='flex';
    }

    function setMode(m) { mode = m; loadList(); }
    function archiveChat() {
        if(!curId || !confirm('–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏?')) return;
        db.ref('support/'+curId).once('value', snap => {
            db.ref('archive/'+curId).set(snap.val());
            db.ref('closed_chats/'+curId).set({lastMsg: "–ó–∞–∫—Ä–∏—Ç–æ", ts: Date.now()});
            db.ref('support/'+curId).remove();
            db.ref('active_chats/'+curId).remove();
            curId = null; document.getElementById('support-msgs').innerHTML = '';
        });
    }
</script>
</body>
</html>
