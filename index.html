<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM | Ultra Glass ‚ùÑÔ∏è</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #e62117; 
            --accent-gradient: linear-gradient(135deg, #ff4b42 0%, #e62117 100%);
            --glass: rgba(255, 255, 255, 0.7);
            --bg: #f0f2f5;
            --card-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: #e2e4e9; height: 100vh; overflow: hidden; }

        /* --- –°–ù–Ü–ì --- */
        .snowflake { position: fixed; top: -10%; z-index: 9999; color: #fff; pointer-events: none; animation: snow-fall 10s linear infinite; }
        @keyframes snow-fall { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }

        /* --- AUTH --- */
        #auth-screen { position: fixed; inset: 0; background: url('https://images.unsplash.com/photo-148337517319d-78344b75784b?q=80&w=1470&auto=format&fit=crop'); background-size: cover; z-index: 999999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .auth-card { width: 340px; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); padding: 40px; border-radius: 40px; text-align: center; box-shadow: var(--card-shadow); border: 1px solid rgba(255,255,255,0.4); }

        /* --- UI COMPONENTS --- */
        .glass-btn { 
            background: var(--accent-gradient); color: #fff; border: none; padding: 12px 24px; 
            border-radius: 18px; font-weight: 700; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 15px rgba(230,33,23,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .glass-btn:active { transform: scale(0.92); filter: brightness(1.1); }

        .input-premium {
            background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.05); padding: 14px 20px;
            border-radius: 20px; font-size: 15px; transition: 0.3s; width: 100%;
        }
        .input-premium:focus { background: #fff; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(230,33,23,0.1); }

        /* --- MAIN LAYOUT --- */
        #crm-ui { display: none; height: 100vh; flex-direction: column; }
        .nav-bar { 
            display: flex; padding: 10px 20px; background: rgba(255,255,255,0.6); 
            backdrop-filter: blur(15px); border-bottom: 1px solid rgba(0,0,0,0.05); gap: 10px; z-index: 10;
        }
        .nav-tab { 
            padding: 10px 20px; border-radius: 15px; font-size: 14px; font-weight: 700; color: #555; 
            cursor: pointer; transition: 0.3s; 
        }
        .nav-tab.active { background: #fff; color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .app-main { flex: 1; display: flex; overflow: hidden; }
        .side-panel { 
            width: 350px; background: rgba(255,255,255,0.4); border-right: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- CHAT ITEMS --- */
        .chat-row { 
            margin: 10px 15px; padding: 15px; background: #fff; border-radius: 22px; 
            cursor: pointer; transition: 0.3s; border: 1px solid transparent; position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .chat-row:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.05); }
        .chat-row.selected { border-color: var(--accent); background: #fff1f0; }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è */
        .assign-trigger { 
            position: absolute; right: 12px; top: 12px; width: 32px; height: 32px; 
            border-radius: 10px; background: #f0f2f5; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: 0.2s; border: none; cursor: pointer;
        }
        .assign-trigger:hover { background: #007aff; color: #fff; }

        /* --- CHAT AREA --- */
        .chat-viewport { flex: 1; display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-attachment: fixed; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { padding: 12px 18px; border-radius: 20px; max-width: 75%; font-size: 14px; line-height: 1.5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .msg.in { align-self: flex-start; background: #fff; border-bottom-left-radius: 4px; color: #1a1a1a; }
        .msg.out { align-self: flex-end; background: var(--accent-gradient); color: #fff; border-bottom-right-radius: 4px; }
        .msg.sys { align-self: center; background: rgba(0,0,0,0.05); font-size: 11px; font-weight: 800; color: #666; padding: 6px 15px; border-radius: 12px; }

        .chat-footer { padding: 20px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); display: flex; gap: 12px; align-items: center; }

        /* --- MODAL --- */
        #modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); 
            z-index: 10000; display: none; align-items: center; justify-content: center; 
        }
        .modal-card { width: 300px; background: #fff; border-radius: 30px; padding: 25px; box-shadow: var(--card-shadow); }
        .mgr-option { padding: 12px; border-radius: 15px; margin-bottom: 8px; cursor: pointer; border: 1px solid #eee; font-weight: 600; text-align: center; }
        .mgr-option:hover { background: var(--accent); color: #fff; }

        @media (max-width: 992px) {
            .side-panel { position: absolute; inset: 0; z-index: 100; width: 100%; }
            .side-panel.hidden { transform: translateX(-100%); }
        }
    </style>
</head>
<body onclick="initAudio()">

    <div id="snow-box"></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color:var(--accent); font-size: 28px; margin:0 0 10px;">üå∂Ô∏è Latiao CRM</h1>
            <p style="font-size:13px; color:#666; margin-bottom:30px;">Winter Security Login</p>
            <input type="text" id="al" class="input-premium" placeholder="–õ–æ–≥—ñ–Ω" style="margin-bottom:12px">
            <input type="password" id="ap" class="input-premium" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom:20px">
            <button class="glass-btn" style="width:100%" onclick="login()">–£–í–Ü–ô–¢–ò</button>
        </div>
    </div>

    <div id="crm-ui">
        <nav class="nav-bar">
            <div class="nav-tab active" onclick="nav('support', this)">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ <b id="chat-count">0</b></div>
            <div id="t-settings" class="nav-tab" onclick="nav('settings', this)">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
        </nav>

        <div class="app-main">
            <aside class="side-panel" id="side-p">
                <div style="padding:20px; background:rgba(255,255,255,0.5)">
                    <div id="greet" style="font-weight:800; font-size:14px"></div>
                    <div style="display:flex; gap:8px; margin-top:15px">
                        <button class="glass-btn" style="flex:1; font-size:10px; padding:10px" onclick="setMode('active')">–ê–ö–¢–ò–í–ù–Ü</button>
                        <button class="glass-btn" style="flex:1; font-size:10px; padding:10px; background:#666" onclick="setMode('archived')">–ê–†–•–Ü–í</button>
                    </div>
                </div>
                <div id="chat-list" style="flex:1; overflow-y:auto"></div>
                <button onclick="logout()" style="padding:20px; color:red; border:none; background:none; font-weight:800; cursor:pointer; width:100%">üö™ –í–∏–π—Ç–∏</button>
            </aside>

            <main class="chat-viewport view-tab active" id="view-support">
                <div class="messages-container" id="m-area"></div>
                <div id="scripts-bar" style="display:flex; gap:8px; padding:10px; overflow-x:auto; background:rgba(255,255,255,0.4)"></div>
                <form class="chat-footer" onsubmit="send(event)">
                    <button type="button" class="glass-btn" style="width:45px; height:45px; padding:0; background:#000" onclick="toggleSide(true)">‚Äπ</button>
                    <input type="text" id="msg-in" class="input-premium" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
                    <button type="submit" class="glass-btn" style="width:50px; height:50px; padding:0; border-radius:50%">‚û§</button>
                </form>
            </main>

            <main class="view-tab" id="view-settings" style="display:none; padding:30px; overflow-y:auto; flex:1; background:#fff">
                <div style="max-width:600px">
                    <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CRM</h2>
                    <div class="auth-card" style="width:100%; text-align:left; margin-bottom:20px">
                        <h4>–ú–µ–Ω–µ–¥–∂–µ—Ä–∏</h4>
                        <div id="mgr-list"></div>
                        <input type="text" id="nm" class="input-premium" placeholder="–Ü–º'—è" style="margin-top:10px">
                        <input type="text" id="nl" class="input-premium" placeholder="–õ–æ–≥—ñ–Ω" style="margin-top:5px">
                        <input type="text" id="np" class="input-premium" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-top:5px">
                        <input type="text" id="nt" class="input-premium" placeholder="Telegram ID" style="margin-top:5px">
                        <button class="glass-btn" style="margin-top:15px; width:100%" onclick="addM()">–î–æ–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h3 style="margin:0 0 15px">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –∞–¥–º—ñ–Ω–∞</h3>
            <div id="mgr-options"></div>
        </div>
    </div>

<script>
    const BOT_TOKEN = "8538208852:AAFASKSeci30FVNU5sPl3vkmVSPLcfWFqEI";
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('user'));
    let curId = null, mode = 'active', managers = {};

    // AUDIO ENGINE
    const sounds = {
        click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
        send: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3')
    };

    function initAudio() { Object.values(sounds).forEach(s => { s.play().then(()=>s.pause()); }); }
    function playS(type) { sounds[type].currentTime=0; sounds[type].play().catch(()=>{}); }

    // SNOW
    for(let i=0;i<25;i++){
        let s=document.createElement('div'); s.className='snowflake'; s.innerHTML='‚ùÑ';
        s.style.left=Math.random()*100+'vw'; s.style.animationDuration=(Math.random()*5+10)+'s';
        document.getElementById('snow-box').appendChild(s);
    }

    function login() {
        const l=document.getElementById('al').value, p=document.getElementById('ap').value;
        if(l==='admin' && p==='latiao2024') return logOk({name:'–í–ª–∞—Å–Ω–∏–∫', role:'admin', id:'admin', tg:'558890365'});
        db.ref('managers').once('value', snap => {
            snap.forEach(m => {
                const d=m.val();
                if(d.login===l && d.pass===p) logOk({name:d.name, role:'manager', id:m.key, tg:d.tgId});
            });
        });
    }
    function logOk(d) { localStorage.setItem('user', JSON.stringify(d)); location.reload(); }
    function logout() { localStorage.clear(); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('crm-ui').style.display='flex';
        document.getElementById('greet').innerText = `–í—ñ—Ç–∞—î–º–æ, ${user.name}! üéÑ`;
        if(user.role !== 'admin') document.getElementById('t-settings').style.display='none';
        init();
    }

    function init() {
        db.ref('managers').on('value', snap => { managers = snap.val() || {}; if(user.role==='admin') renderMgrs(); loadList(); });
        db.ref('active_chats').on('value', snap => {
            document.getElementById('chat-count').innerText = snap.numChildren();
            loadList();
        });
        db.ref('config/scripts').on('value', snap => {
            const sc = snap.val() || [];
            const bar = document.getElementById('scripts-bar'); bar.innerHTML = '';
            sc.forEach(s => {
                const b = document.createElement('button'); b.className='nav-tab'; b.innerText=s.title;
                b.onclick=()=>document.getElementById('msg-in').value=s.text;
                bar.appendChild(b);
            });
        });
    }

    function loadList() {
        const path = mode==='active'?'active_chats':'closed_chats';
        db.ref(path).once('value', snap => {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                if(user.role==='manager' && d.assignedTo && d.assignedTo !== user.id) return;

                const div = document.createElement('div');
                div.className = `chat-row ${curId===c.key?'selected':''}`;
                const mName = d.assignedTo==='admin'?'–í–ª–∞—Å–Ω–∏–∫':(managers[d.assignedTo]?.name || '‚Äî');
                
                div.innerHTML = `
                    <div style="font-weight:800; font-size:15px">üë§ ${c.key.substring(0,8)}</div>
                    <div style="font-size:12px; color:#888; margin-top:4px">${d.lastMsg || '–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å'}</div>
                    ${d.assignedTo ? `<div style="font-size:10px; color:var(--accent); font-weight:800; margin-top:5px">üß§ ${mName}</div>` : ''}
                `;

                if(user.role==='admin') {
                    const btn = document.createElement('button');
                    btn.className = 'assign-trigger'; btn.innerHTML = 'üë§';
                    btn.onclick = (e) => { e.stopPropagation(); openAssign(c.key); };
                    div.appendChild(btn);
                }

                div.onclick = () => { curId=c.key; openChat(c.key); if(window.innerWidth<992) toggleSide(false); };
                list.appendChild(div);
            });
        });
    }

    function openAssign(cid) {
        document.getElementById('modal-overlay').style.display='flex';
        const opt = document.getElementById('mgr-options'); opt.innerHTML = `<div class="mgr-option" onclick="assign('${cid}','admin')">–í–ª–∞—Å–Ω–∏–∫</div>`;
        Object.keys(managers).forEach(id => {
            opt.innerHTML += `<div class="mgr-option" onclick="assign('${cid}','${id}')">${managers[id].name}</div>`;
        });
    }
    function closeModal() { document.getElementById('modal-overlay').style.display='none'; }

    function assign(cid, mid) {
        const name = mid==='admin'?'–í–ª–∞—Å–Ω–∏–∫':managers[mid].name;
        db.ref('active_chats/'+cid).update({assignedTo: mid});
        db.ref('support/'+cid).push({text: `üß§ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –∞–¥–º—ñ–Ω–∞: ${name}`, type:'sys', ts: Date.now()});
        closeModal(); playS('click');
    }

    function openChat(id) {
        const path = mode==='active'?'support/':'archive/';
        db.ref(path+id).on('value', snap => {
            const area = document.getElementById('m-area'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                area.innerHTML += `<div class="msg ${d.type==='sys'?'sys':(d.type==='admin'||d.type==='out'?'out':'in')}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function send(e) {
        e.preventDefault(); const i=document.getElementById('msg-in');
        if(!curId || !i.value) return;
        playS('send');
        db.ref('support/'+curId).push({text: i.value, type:'out', ts: Date.now()});
        db.ref('active_chats/'+curId).update({lastMsg: "–í–∏: "+i.value});
        i.value='';
    }

    function toggleSide(s) { document.getElementById('side-p').classList.toggle('hidden', !s); playS('click'); }
    function nav(t, el) {
        document.querySelectorAll('.view-tab').forEach(v=>v.style.display='none');
        document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
        document.getElementById('view-'+t).style.display='flex'; el.classList.add('active');
        playS('click');
    }

    function addM() {
        const n=document.getElementById('nm').value, l=document.getElementById('nl').value, p=document.getElementById('np').value, t=document.getElementById('nt').value;
        if(n && l && p) db.ref('managers').push({name:n, login:l, pass:p, tgId:t});
    }
    function renderMgrs() {
        const l = document.getElementById('mgr-list'); l.innerHTML = '';
        Object.keys(managers).forEach(id => {
            l.innerHTML += `<div class="mgr-option" style="display:flex; justify-content:space-between; cursor:default">
                <span>${managers[id].name}</span><button onclick="db.ref('managers/${id}').remove()" style="color:red;border:none;background:none">‚úï</button>
            </div>`;
        });
    }
</script>
</body>
</html>
