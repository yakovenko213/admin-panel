<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao Ultra CRM | Advanced Control</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #e62117;
            --accent-soft: rgba(230, 33, 23, 0.08);
            --chrome-bg: #dee1e6;
            --chrome-tab: #ffffff;
            --sidebar-bg: #f7f9fc;
            --border: #e0e4e9;
            --text-primary: #1a1d21;
            --text-secondary: #5f6368;
            --success: #34c759;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: var(--chrome-bg); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- CHROME TABS --- */
        .chrome-tabs-container { display: flex; align-items: flex-end; padding: 8px 8px 0 8px; gap: 4px; background: var(--chrome-bg); }
        .chrome-tab {
            position: relative; padding: 10px 25px; min-width: 160px; height: 38px;
            background: transparent; border-radius: 10px 10px 0 0;
            cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-secondary);
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .chrome-tab.active { background: var(--chrome-tab); color: var(--accent); font-weight: 600; }
        .chrome-tab.active::before { content: ''; position: absolute; bottom: 0; left: -20px; width: 20px; height: 20px; border-bottom-right-radius: 12px; box-shadow: 10px 0 0 0 var(--chrome-tab); }
        .chrome-tab.active::after { content: ''; position: absolute; bottom: 0; right: -20px; width: 20px; height: 20px; border-bottom-left-radius: 12px; box-shadow: -10px 0 0 0 var(--chrome-tab); }

        /* --- LAYOUT --- */
        .app-window { flex: 1; display: flex; background: var(--chrome-tab); position: relative; z-index: 10; overflow: hidden; }
        
        /* Sidebar Support Filters */
        .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .support-filters { display: flex; padding: 10px; gap: 5px; border-bottom: 1px solid var(--border); }
        .s-filter-btn { flex: 1; padding: 6px; font-size: 11px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; background: #eee; color: #888; }
        .s-filter-btn.active { background: var(--accent); color: #fff; }

        .chat-list { flex: 1; overflow-y: auto; padding: 8px; }
        .chat-card { padding: 12px 16px; border-radius: 12px; cursor: pointer; margin-bottom: 4px; border: 1px solid transparent; }
        .chat-card.active { background: var(--accent-soft); border-color: rgba(230,33,23,0.1); }

        /* Workspace */
        .workspace { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .workspace-header { padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        .messages-area { flex: 1; padding: 25px; overflow-y: auto; background: #fdfdfe; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 16px; border-radius: 16px; max-width: 75%; font-size: 14px; position: relative; }
        .bubble.user { align-self: flex-start; background: #f1f3f4; }
        .bubble.admin { align-self: flex-end; background: var(--accent); color: #fff; }
        .del-msg { position: absolute; top: -5px; right: -5px; background: #000; color: #fff; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: none; align-items: center; justify-content: center; cursor: pointer; }
        .bubble:hover .del-msg { display: flex; }

        /* Tools */
        .community-tools { width: 340px; border-left: 1px solid var(--border); background: var(--sidebar-bg); padding: 20px; overflow-y: auto; }
        .tool-card { background: #fff; border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .input-std { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 8px; font-size: 13px; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; }

        /* Settings View */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 40px; max-width: 1000px; }
        
        #auth-gate { position: fixed; inset: 0; background: #fff; z-index: 99999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="chrome-tabs-container">
        <div class="chrome-tab active" onclick="switchMainTab('support', this)"><span>üí¨ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞</span></div>
        <div class="chrome-tab" onclick="switchMainTab('community', this)"><span>üå∂Ô∏è –°–ø—ñ–ª—å–Ω–æ—Ç–∞</span></div>
        <div class="chrome-tab" onclick="switchMainTab('settings', this)"><span>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></div>
        <div class="chrome-tab" onclick="switchMainTab('stats', this)"><span>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></div>
    </div>

    <div class="app-window">
        
        <aside class="sidebar" id="sidebar-panel">
            <div class="support-filters">
                <button class="s-filter-btn active" id="f-act" onclick="toggleSupportMode('active')">–í—ñ–¥–∫—Ä–∏—Ç—ñ</button>
                <button class="s-filter-btn" id="f-arc" onclick="toggleSupportMode('archived')">–ê—Ä—Ö—ñ–≤</button>
            </div>
            <div class="chat-list" id="chat-list-data"></div>
        </aside>

        <main class="workspace tab-view active" id="view-support">
            <div class="workspace-header">
                <b id="active-user-name">–û–±–µ—Ä—ñ—Ç—å –¥—ñ–∞–ª–æ–≥</b>
                <button class="btn-main" style="width:auto; background:#333" onclick="archiveChat()">–ó–∞–∫—Ä–∏—Ç–∏ —á–∞—Ç</button>
            </div>
            <div class="messages-area" id="support-msgs"></div>
            <form class="input-bar" style="padding:15px; display:flex; gap:10px;" onsubmit="sendSupport(event)">
                <input type="text" id="support-input" class="input-std" style="margin:0; border-radius:20px" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å –∫–ª—ñ—î–Ω—Ç—É...">
                <button type="submit" class="btn-main" style="width:auto; border-radius:20px">‚û§</button>
            </form>
        </main>

        <main class="workspace tab-view" id="view-community" style="display:none; flex-direction: row;">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="workspace-header"><b>–ú–æ–¥–µ—Ä–∞—Ü—ñ—è –°–ø—ñ–ª—å–Ω–æ—Ç–∏</b> <button class="btn-main" style="width:auto; background:red; font-size:10px" onclick="clearCommunity()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å —á–∞—Ç</button></div>
                <div class="messages-area" id="community-msgs"></div>
                <form class="input-bar" style="padding:15px; display:flex; gap:10px;" onsubmit="sendCommunity(event)">
                    <input type="text" id="community-input" class="input-std" style="margin:0; border-radius:20px" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ SHOP...">
                    <button type="submit" class="btn-main" style="width:auto; border-radius:20px; background:#000">‚û§</button>
                </form>
            </div>
            <aside class="community-tools">
                <div class="tool-card">
                    <h4>–Æ–∑–µ—Ä–∏ –æ–Ω–ª–∞–π–Ω</h4>
                    <div id="online-users-list"></div>
                </div>
                <div class="tool-card">
                    <h4>–†–µ–∫–ª–∞–º–Ω–∞ —Ä–æ–∑—Å–∏–ª–∫–∞</h4>
                    <input type="text" id="ad-url" class="input-std" placeholder="URL —Ñ–æ—Ç–æ">
                    <textarea id="ad-txt" class="input-std" placeholder="–¢–µ–∫—Å—Ç..."></textarea>
                    <button class="btn-main" onclick="pushAd()">–ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
                </div>
            </aside>
        </main>

        <main class="workspace tab-view" id="view-settings" style="display:none; overflow-y:auto;">
            <div class="settings-grid">
                <div class="tool-card">
                    <h4>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è —á–∞—Ç—É</h4>
                    <label style="font-size:12px">–ê–≤—Ç–æ–≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–∏ –Ω–æ–≤–æ–º—É —á–∞—Ç—ñ:</label>
                    <textarea id="set-welcome" class="input-std" placeholder="–í—ñ—Ç–∞—î–º–æ —É Latiao! –ß–∏–º –¥–æ–ø–æ–º–æ–≥—Ç–∏?"></textarea>
                    
                    <label style="font-size:12px">–ê–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É —á–µ—Ä–µ–∑ (—Ö–≤–∏–ª–∏–Ω):</label>
                    <input type="number" id="set-close-time" class="input-std" value="60">
                    
                    <button class="btn-main" onclick="saveSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                </div>
                <div class="tool-card">
                    <h4>–ë–∞–∑–∞ —à–≤–∏–¥–∫–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π (FAQ)</h4>
                    <div id="faq-list-admin" style="margin-bottom:10px"></div>
                    <input type="text" id="faq-q" class="input-std" placeholder="–ü–∏—Ç–∞–Ω–Ω—è">
                    <input type="text" id="faq-a" class="input-std" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å">
                    <button class="btn-main" style="background:#007aff" onclick="addFAQ()">–î–æ–¥–∞—Ç–∏ –≤ —á–∞—Ç –∫–ª—ñ—î–Ω—Ç—É</button>
                </div>
            </div>
        </main>

    </div>

    <div id="auth-gate">
        <div style="text-align:center; width: 320px; padding: 40px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); background:#fff">
            <h2 style="color:var(--accent)">Latiao CRM</h2>
            <input type="password" id="gate-pass" class="input-std" style="text-align:center" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-main" onclick="checkGate()">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let activeSupportId = null;
    let supportMode = 'active';

    function checkGate() {
        if(document.getElementById('gate-pass').value === 'latiao2025') {
            document.getElementById('auth-gate').style.display = 'none';
            initCRM();
        }
    }

    function switchMainTab(view, el) {
        document.querySelectorAll('.tab-view').forEach(v => v.style.display = 'none');
        document.querySelectorAll('.chrome-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('view-' + view).style.display = (view === 'community' ? 'flex' : 'flex');
        if(view === 'settings') document.getElementById('view-settings').style.display = 'block';
        el.classList.add('active');
        document.getElementById('sidebar-panel').style.display = (view === 'support') ? 'flex' : 'none';
    }

    function toggleSupportMode(mode) {
        supportMode = mode;
        document.querySelectorAll('.s-filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode === 'active' ? 'f-act' : 'f-arc').classList.add('active');
        loadSupportList();
    }

    function initCRM() {
        loadSupportList();
        // –°–ø—ñ–ª—å–Ω–æ—Ç–∞
        db.ref('messages').on('value', snap => {
            const area = document.getElementById('community-msgs');
            area.innerHTML = '';
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div');
                div.className = `bubble ${m.uid === 'SHOP' ? 'admin' : 'user'}`;
                div.innerHTML = `<div class="del-msg" onclick="deleteCommMsg('${c.key}')">‚úï</div><small style="display:block;font-size:9px;opacity:0.6">${m.name}</small>${m.text}`;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });

        // –û–Ω–ª–∞–π–Ω —é–∑–µ—Ä–∏
        db.ref('presence').on('value', snap => {
            const list = document.getElementById('online-users-list');
            list.innerHTML = '';
            snap.forEach(child => {
                const u = child.val();
                list.innerHTML += `<div class="user-row"><span>${u.name}</span><button class="btn-main" style="width:auto; padding:2px 8px; font-size:9px" onclick="adminAction('${child.key}')">–î—ñ—è</button></div>`;
            });
        });
    }

    function loadSupportList() {
        const path = supportMode === 'active' ? 'active_chats' : 'closed_chats';
        db.ref(path).on('value', snap => {
            const list = document.getElementById('chat-list-data');
            list.innerHTML = '';
            snap.forEach(child => {
                const div = document.createElement('div');
                div.className = `chat-card ${activeSupportId === child.key ? 'active' : ''}`;
                div.innerHTML = `<strong>üë§ ${child.key.substring(0,10)}</strong><small>${child.val().lastMsg || '...'}</small>`;
                div.onclick = () => selectSupport(child.key);
                list.appendChild(div);
            });
        });
    }

    function selectSupport(id) {
        activeSupportId = id;
        const path = supportMode === 'active' ? 'support/' : 'archive/';
        db.ref(path + id).on('value', snap => {
            const area = document.getElementById('support-msgs');
            area.innerHTML = '';
            snap.forEach(child => {
                const m = child.val();
                const div = document.createElement('div');
                div.className = 'bubble ' + (m.type === 'admin' ? 'admin' : 'user');
                div.innerText = m.text;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });
        loadSupportList();
    }

    function sendSupport(e) {
        e.preventDefault();
        const input = document.getElementById('support-input');
        if(!activeSupportId || !input.value) return;
        db.ref('support/' + activeSupportId).push({ text: input.value, type: 'admin', ts: Date.now() });
        db.ref('active_chats/' + activeSupportId).update({ lastMsg: "–í–∏: " + input.value, ts: Date.now() });
        input.value = '';
    }

    function archiveChat() {
        if(!activeSupportId) return;
        db.ref('support/' + activeSupportId).once('value', snap => {
            db.ref('archive/' + activeSupportId).set(snap.val());
            db.ref('closed_chats/' + activeSupportId).set({ ts: Date.now(), lastMsg: "–î—ñ–∞–ª–æ–≥ –∑–∞–∫—Ä–∏—Ç–æ" });
            db.ref('support/' + activeSupportId).remove();
            db.ref('active_chats/' + activeSupportId).remove();
            activeSupportId = null;
            document.getElementById('support-msgs').innerHTML = '';
        });
    }

    // COMMUNITY MODERATION
    function deleteCommMsg(id) { if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?')) db.ref('messages/' + id).remove(); }
    function clearCommunity() { if(confirm('–û–ß–ò–°–¢–ò–¢–ò –í–ï–°–¨ –ß–ê–¢ –°–ü–Ü–õ–¨–ù–û–¢–ò?')) db.ref('messages').remove(); }
    
    function sendCommunity(e) {
        e.preventDefault();
        const val = document.getElementById('community-input').value;
        if(val) db.ref('messages').push({ uid: 'SHOP', name: 'ADMIN', text: val, ts: Date.now() });
        document.getElementById('community-input').value = '';
    }

    function pushAd() {
        const text = document.getElementById('ad-txt').value;
        const img = document.getElementById('ad-url').value;
        if(text) db.ref('messages').push({ uid: 'SHOP', name: 'üõçÔ∏è Latiao PROMO', text, img, ts: Date.now() });
    }

    // SETTINGS & FAQ
    function saveSettings() {
        const welcome = document.getElementById('set-welcome').value;
        const time = document.getElementById('set-close-time').value;
        db.ref('crm_settings').set({ welcomeText: welcome, autoCloseMin: time });
        alert('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
    }

    function addFAQ() {
        const q = document.getElementById('faq-q').value;
        const a = document.getElementById('faq-a').value;
        if(q && a) db.ref('faq_base').push({ q, a });
        document.getElementById('faq-q').value = '';
        document.getElementById('faq-a').value = '';
    }

    window.adminAction = (uid) => {
        const act = prompt("1: –ü—Ä–∏–≤–∞—Ç, 2: –ó–∞–ø–∏—Ç ‚Ññ, 3: –ë–∞–Ω");
        if(act == "1") db.ref('private_messages/' + uid).push({ text: prompt("–¢–µ–∫—Å—Ç:"), ts: Date.now() });
        if(act == "2") db.ref('presence/' + uid).update({ requirePhone: true });
        if(act == "3") db.ref('banned_users/' + uid).set({ ts: Date.now() });
    };
</script>
</body>
</html>
