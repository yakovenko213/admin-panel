<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Latiao CRM PRO | Deluxe Edition ‚ùÑÔ∏è</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #e62117; 
            --accent-glow: rgba(230, 33, 23, 0.08); 
            --chrome-bg: #dfe1e5; 
            --chrome-tab: #ffffff; 
            --sidebar-bg: #f8f9fa; 
            --border: #e8eaed; 
            --gold: #ffd700;
            --glass: rgba(255, 255, 255, 0.8);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--chrome-bg); display: flex; flex-direction: column; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes snow-fall { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }

        .snowflake { position: fixed; top: -10%; z-index: 9999; color: #fff; font-size: 1em; pointer-events: none; animation: snow-fall 10s linear infinite; }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1470&auto=format&fit=crop'); background-size: cover; z-index: 999999; display: flex; align-items: center; justify-content: center; }
        .auth-card { width: 360px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 30px; text-align: center; border: 2px solid var(--gold); animation: fadeIn 0.5s ease; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 15px; border: 1px solid #ddd; transition: 0.3s; }
        .auth-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }
        .auth-btn { width: 100%; padding: 15px; background: var(--accent); color: #fff; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .auth-btn:active { transform: scale(0.96); }

        /* UI */
        #crm-ui { display: none; height: 100%; flex-direction: column; }
        .chrome-header { display: flex; align-items: flex-end; padding: 8px 8px 0; background: var(--chrome-bg); border-bottom: 1px solid #c1c3c8; gap: 4px; flex-shrink: 0; }
        .tab { padding: 10px 20px; min-width: 140px; height: 38px; border-radius: 12px 12px 0 0; cursor: pointer; font-size: 13px; font-weight: 600; color: #555; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .tab.active { background: #fff; color: var(--accent); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }

        .app-shell { flex: 1; display: flex; background: #fff; overflow: hidden; }
        .sidebar { width: 340px; border-right: 1px solid var(--border); background: var(--sidebar-bg); display: flex; flex-direction: column; }
        
        .chat-item { 
            padding: 15px; border-radius: 20px; margin: 8px; background: #fff; border: 1px solid #eee; 
            cursor: pointer; position: relative; transition: 0.3s; animation: slideIn 0.3s ease forwards;
        }
        .chat-item:hover { transform: translateX(5px); border-color: var(--accent); }
        .chat-item.active-chat { background: var(--accent-glow); border-color: var(--accent); }
        .tag-mgr { position: absolute; right: 12px; top: 12px; font-size: 9px; padding: 3px 8px; border-radius: 6px; background: #007aff; color: #fff; font-weight: 800; }

        /* MESSAGES */
        .viewport { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .msg-area { flex: 1; padding: 20px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 12px 18px; border-radius: 22px; max-width: 75%; font-size: 14px; animation: fadeIn 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .bubble.in { align-self: flex-start; background: #fff; border-bottom-left-radius: 4px; }
        .bubble.out { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.sys { align-self: center; background: #cbd5e1; font-size: 10px; font-weight: 800; padding: 5px 15px; }

        .scripts-bar { display: flex; gap: 8px; overflow-x: auto; padding: 12px; border-top: 1px solid #eee; scrollbar-width: none; }
        .script-btn { flex-shrink: 0; padding: 8px 16px; background: #fff; border: 1px solid #ddd; border-radius: 12px; font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .script-btn:active { transform: scale(0.9); background: #eee; }

        .footer { padding: 15px; display: flex; gap: 12px; border-top: 1px solid #eee; }
        .footer input { flex: 1; padding: 14px 20px; border-radius: 25px; border: 1px solid #eee; background: #f5f5f5; font-size: 15px; transition: 0.3s; }
        .footer input:focus { background: #fff; border-color: var(--accent); }

        .set-card { background: #fff; padding: 25px; border-radius: 25px; border: 1px solid #eee; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }

        /* MOBILE ADAPTIVITY */
        @media (max-width: 992px) {
            .sidebar { width: 100%; position: absolute; inset: 0; z-index: 100; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
            .sidebar.hidden { transform: translateX(-100%); }
        }
    </style>
</head>
<body onclick="playClick()">

    <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" preload="auto"></audio>
    <audio id="snd-send" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

    <div id="snow-container"></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color:var(--accent); margin:0 0 10px 0;">Latiao CRM</h2>
            <p style="font-size:13px; color:#666; margin-bottom:30px;">–ó–∏–º–æ–≤–∏–π —Å–µ–∑–æ–Ω 2026 ‚ùÑÔ∏è</p>
            <input type="text" id="auth-l" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="auth-p" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="tryLogin()">–£–í–Ü–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
        </div>
    </div>

    <div id="crm-ui">
        <header class="chrome-header">
            <div class="tab active" onclick="nav('support', this)"><span>üí¨ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞</span> <b id="chat-count" style="margin-left:5px">0</b></div>
            <div id="t-set" class="tab" onclick="nav('settings', this)"><span>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></div>
        </header>

        <div class="app-shell">
            <aside class="sidebar" id="side-panel">
                <div style="padding:20px; border-bottom:1px solid #eee; background:#fff">
                    <div id="greeting-txt" style="font-weight:800; font-size:13px;"></div>
                    <div style="display:flex; gap:8px; margin-top:15px">
                        <button class="auth-btn" style="padding:8px; font-size:11px; flex:1" onclick="setMode('active')">–ê–ö–¢–ò–í–ù–Ü</button>
                        <button class="auth-btn" style="padding:8px; font-size:11px; flex:1; background:#666" onclick="setMode('archived')">–ê–†–•–Ü–í</button>
                    </div>
                </div>
                <div id="chat-list" class="chat-list" style="flex:1; overflow-y:auto"></div>
                <button onclick="logout()" style="padding:20px; color:red; border:none; background:none; font-weight:bold; cursor:pointer; width:100%; text-align:center;">üö™ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–æ–±–æ—Ç—É</button>
            </aside>

            <main class="viewport view-tab active" id="view-support">
                <div class="top-nav">
                    <button class="auth-btn" style="width:40px; height:40px; padding:0; background:#000; display:none" id="m-back" onclick="toggleSidebar(false)">‚Äπ</button>
                    <b id="active-user-name" style="font-size:14px; margin-left:10px">–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç</b>
                    <button style="margin-left:auto; border:none; background:none; color:var(--accent); font-weight:800; cursor:pointer;" onclick="archiveChat()">–ó–ê–ö–†–ò–¢–ò</button>
                </div>
                <div class="msg-area" id="support-msgs"></div>
                <div id="scripts-chat-bar" class="scripts-bar"></div>
                <form class="footer" onsubmit="sendMsg(event)">
                    <input type="text" id="msg-input" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                    <button type="submit" style="background:#000; color:#fff; border:none; width:46px; height:46px; border-radius:50%; cursor:pointer; transition:0.2s;" id="send-btn">‚û§</button>
                </form>
            </main>

            <main class="viewport view-tab" id="view-settings" style="display:none; padding:20px; overflow-y:auto;">
                <div class="set-card" id="admin-only-mgr">
                    <h4>ü§∂ –ö–µ—Ä—É–≤–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏</h4>
                    <div id="mgr-list"></div>
                    <hr style="margin:20px 0; border:none; border-top:1px solid #eee">
                    <input type="text" id="n-m-name" class="auth-input" placeholder="–Ü–º'—è">
                    <input type="text" id="n-m-log" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω">
                    <input type="text" id="n-m-pas" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                    <input type="text" id="n-m-tg" class="auth-input" placeholder="Telegram Chat ID">
                    <button class="auth-btn" onclick="addMgr()">–°–¢–í–û–†–ò–¢–ò –ú–ï–ù–ï–î–ñ–ï–†–ê</button>
                </div>
                <div class="set-card">
                    <h4>ü§ñ FAQ —Ç–∞ –°–∫—Ä–∏–ø—Ç–∏</h4>
                    <button class="auth-btn" onclick="addFAQRow()">+ –ù–æ–≤–µ –ü–∏—Ç–∞–Ω–Ω—è</button>
                    <button class="auth-btn" style="margin-top:10px" onclick="addScriptRow()">+ –ù–æ–≤–∏–π –°–∫—Ä–∏–ø—Ç</button>
                    <button class="auth-btn" style="margin-top:20px; background:#000" onclick="saveAllConfig()">–ó–ë–ï–†–ï–ì–¢–ò –í–°–ï</button>
                    <div id="config-editor" style="margin-top:20px"></div>
                </div>
            </main>
        </div>
    </div>

<script>
    const BOT_TOKEN = "8538208852:AAFASKSeci30FVNU5sPl3vkmVSPLcfWFqEI";
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(localStorage.getItem('user'));
    let curId = null, mode = 'active', managers = {}, scripts = [], faqs = [];

    // SOUND FUNCTIONS
    function playClick() { document.getElementById('snd-click').currentTime=0; document.getElementById('snd-click').play().catch(()=>{}); }
    function playSend() { document.getElementById('snd-send').currentTime=0; document.getElementById('snd-send').play().catch(()=>{}); }

    // SNOW EFFECT
    for(let i=0;i<25;i++){
        let s=document.createElement('div'); s.className='snowflake'; s.innerHTML='‚ùÑ';
        s.style.left=Math.random()*100+'vw'; s.style.animationDuration=(Math.random()*5+5)+'s';
        document.getElementById('snow-container').appendChild(s);
    }

    function tryLogin() {
        const l=document.getElementById('auth-l').value, p=document.getElementById('auth-p').value;
        if(l==='admin' && p==='latiao2024') return loginOk({name:'–ë–æ—Å—Å', role:'admin', id:'admin', tgId:'558890365'});
        db.ref('managers').once('value', snap => {
            let f=false;
            snap.forEach(m => {
                const d=m.val();
                if(d.login===l && d.pass===p) { loginOk({name:d.name, role:'manager', id:m.key, tgId:d.tgId}); f=true; }
            });
            if(!f) alert('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó');
        });
    }

    function loginOk(d) { localStorage.setItem('user', JSON.stringify(d)); location.reload(); }
    function logout() { localStorage.clear(); location.reload(); }

    if(user) {
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('crm-ui').style.display='flex';
        const hr = new Date().getHours();
        document.getElementById('greeting-txt').innerText = `${hr<12?"–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É":hr<18?"–î–æ–±—Ä–æ–≥–æ –¥–Ω—è":"–î–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞"}, ${user.name}! üéÑ`;
        if(user.role !== 'admin') document.getElementById('t-set').style.display='none';
        if(window.innerWidth < 992) document.getElementById('m-back').style.display='block';
        init();
    }

    function init() {
        db.ref('managers').on('value', snap => { managers = snap.val() || {}; if(user.role==='admin') renderMgrList(); loadList(); });
        db.ref('config').on('value', snap => {
            const cfg = snap.val() || {};
            scripts = cfg.scripts || []; faqs = cfg.faq || [];
            renderScriptsToChat();
            if(user.role==='admin') renderConfigEditors();
        });
        db.ref('active_chats').on('value', snap => {
            document.getElementById('chat-count').innerText = snap.numChildren();
            smartAssign(snap.val());
            loadList();
        });
        setInterval(checkEscalation, 60000);
    }

    // SMART LOGIC
    function smartAssign(chats) {
        if(!chats || new Date().getHours() < 8) return;
        const av = Object.keys(managers).filter(id => managers[id].tgId);
        if(user.role==='admin') av.push('admin');
        if(av.length === 0) return;
        Object.keys(chats).forEach(cid => {
            if(!chats[cid].assignedTo) assign(cid, av[Math.floor(Math.random()*av.length)], "–ê–≤—Ç–æ-—á–µ—Ä–≥–∞");
        });
    }

    function checkEscalation() {
        const now = Date.now();
        db.ref('active_chats').once('value', snap => {
            snap.forEach(c => {
                const d = c.val();
                if(d.assignedTo && d.assignedTo !== 'admin' && d.lastClientMsgTs && (now - d.lastClientMsgTs) > 300000) {
                    assign(c.key, 'admin', "‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ 5—Ö–≤! –í–ª–∞—Å–Ω–∏–∫ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π");
                }
            });
        });
    }

    function assign(cid, mid, reason) {
        const name = mid==='admin'?'–ë–æ—Å—Å':managers[mid].name;
        const tg = mid==='admin'?'558890365':managers[mid].tgId;
        db.ref('active_chats/'+cid).update({ assignedTo: mid, assignedAt: Date.now() });
        db.ref('support/'+cid).push({ text: `üß§ ${reason}: ${name}`, type: 'sys', ts: Date.now() });
        if(tg) fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({chat_id: tg, text: `üîî –ù–û–í–ò–ô –ß–ê–¢!\n–ö–ª—ñ—î–Ω—Ç: ${cid.substring(0,8)}\n${reason}`})
        });
    }

    // UI RENDERERS
    function toggleSidebar(show) { document.getElementById('side-panel').classList.toggle('hidden', !show); }

    function loadList() {
        const path = mode==='active'?'active_chats':'closed_chats';
        db.ref(path).once('value', snap => {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                if(user.role==='manager' && d.assignedTo && d.assignedTo !== user.id) return;
                const div = document.createElement('div');
                div.className = `chat-item ${curId===c.key?'active-chat':''}`;
                const mName = d.assignedTo==='admin'?'–ë–æ—Å—Å':(managers[d.assignedTo]?.name || '–í—ñ–ª—å–Ω–∏–π');
                div.innerHTML = `<strong>üë§ ${c.key.substring(0,8)}</strong><br><small>${d.lastMsg||'...'}</small>
                                 ${d.assignedTo?`<span class="tag-mgr">${mName}</span>`:''}`;
                div.onclick = () => { 
                    curId=c.key; openChat(c.key); 
                    if(window.innerWidth<992) toggleSidebar(false); 
                };
                list.appendChild(div);
            });
        });
    }

    function openChat(id) {
        document.getElementById('active-user-name').innerText = "–ö–ª—ñ—î–Ω—Ç: " + id.substring(0,8);
        const path = mode==='active'?'support/':'archive/';
        db.ref(path+id).on('value', snap => {
            const area = document.getElementById('support-msgs'); area.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                area.innerHTML += `<div class="bubble ${d.type}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendMsg(e) {
        if(e) e.preventDefault(); 
        const i = document.getElementById('msg-input');
        if(!curId || !i.value) return;
        playSend();
        db.ref('support/'+curId).push({ text: i.value, type: 'out', ts: Date.now() });
        db.ref('active_chats/'+curId).update({ lastMsg: "–í—ñ–¥–ø–æ–≤—ñ–¥—å: "+i.value, lastClientMsgTs: null });
        i.value = '';
    }

    function renderScriptsToChat() {
        const bar = document.getElementById('scripts-chat-bar'); bar.innerHTML = '';
        scripts.forEach(s => {
            const btn = document.createElement('button'); btn.className = 'script-btn'; btn.innerText = s.title;
            btn.onclick = (e) => { e.stopPropagation(); document.getElementById('msg-input').value = s.text; };
            bar.appendChild(btn);
        });
    }

    function renderConfigEditors() {
        const area = document.getElementById('config-editor'); area.innerHTML = '';
        faqs.forEach((f, i) => {
            area.innerHTML += `<div class="set-card"><b>FAQ –ü–∏—Ç–∞–Ω–Ω—è:</b><input class="auth-input" value="${f.q}" onchange="faqs[${i}].q=this.value"><textarea class="auth-input" onchange="faqs[${i}].a=this.value">${f.a}</textarea><button onclick="faqs.splice(${i},1);renderConfigEditors()" style="color:red;border:none;background:none;">–í–∏–¥–∞–ª–∏—Ç–∏</button></div>`;
        });
        scripts.forEach((s, i) => {
            area.innerHTML += `<div class="set-card"><b>–°–∫—Ä–∏–ø—Ç –ê–¥–º—ñ–Ω–∞:</b><input class="auth-input" value="${s.title}" onchange="scripts[${i}].title=this.value"><textarea class="auth-input" onchange="scripts[${i}].text=this.value">${s.text}</textarea><button onclick="scripts.splice(${i},1);renderConfigEditors()" style="color:red;border:none;background:none;">–í–∏–¥–∞–ª–∏—Ç–∏</button></div>`;
        });
    }

    function saveAllConfig() { db.ref('config').set({faq: faqs, scripts: scripts}).then(()=>alert('–í—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ! ‚ùÑÔ∏è')); }
    function addFAQRow() { faqs.push({q:'–ù–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è', a:'–í—ñ–¥–ø–æ–≤—ñ–¥—å'}); renderConfigEditors(); }
    function addScriptRow() { scripts.push({title:'–ö–Ω–æ–ø–∫–∞', text:'–¢–µ–∫—Å—Ç'}); renderConfigEditors(); }

    function renderMgrList() {
        const l = document.getElementById('mgr-list'); l.innerHTML = '';
        Object.keys(managers).forEach(id => {
            l.innerHTML += `<div style="background:#f1f3f4; padding:12px; border-radius:15px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                <span><b>${managers[id].name}</b><br><small>TG: ${managers[id].tgId}</small></span>
                <button onclick="db.ref('managers/${id}').remove()" style="color:red; border:none; background:none; cursor:pointer; font-size:18px;">‚úï</button>
            </div>`;
        });
    }

    function addMgr() {
        const n=document.getElementById('n-m-name').value, l=document.getElementById('n-m-log').value, p=document.getElementById('n-m-pas').value, t=document.getElementById('n-m-tg').value;
        if(n && l && p) db.ref('managers').push({name:n, login:l, pass:p, tgId:t});
    }

    function nav(t, el) {
        document.querySelectorAll('.view-tab').forEach(v=>v.style.display='none');
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.getElementById('view-'+t).style.display='flex'; el.classList.add('active');
        if(t==='support') toggleSidebar(true);
    }

    function setMode(m) { mode = m; loadList(); }
    function archiveChat() {
        if(!curId || !confirm('–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ –¥—ñ–∞–ª–æ–≥?')) return;
        db.ref('support/'+curId).once('value', snap => {
            db.ref('archive/'+curId).set(snap.val());
            db.ref('closed_chats/'+curId).set({lastMsg: "–ó–∞–∫—Ä–∏—Ç–æ", ts: Date.now()});
            db.ref('support/'+curId).remove();
            db.ref('active_chats/'+curId).remove();
            curId = null; document.getElementById('support-msgs').innerHTML = '';
            toggleSidebar(true);
        });
    }
</script>
</body>
</html>
